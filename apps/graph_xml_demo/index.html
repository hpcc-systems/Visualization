<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>HPCCJS Graph2</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <script src='https://cdn.jsdelivr.net/npm/@hpcc-js/util'></script>
    <script src='https://cdn.jsdelivr.net/npm/@hpcc-js/common'></script>
    <script src='https://cdn.jsdelivr.net/npm/@hpcc-js/api'></script>
    <script src='https://cdn.jsdelivr.net/npm/@hpcc-js/dataflow'></script>
    <script src='https://cdn.jsdelivr.net/npm/@hpcc-js/chart'></script>
    <script src='https://cdn.jsdelivr.net/npm/@hpcc-js/layout'></script>
    <script src='https://cdn.jsdelivr.net/npm/@hpcc-js/html'></script>
    <script src='https://cdn.jsdelivr.net/npm/@hpcc-js/dgrid-shim'></script>
    <script src='https://cdn.jsdelivr.net/npm/@hpcc-js/dgrid'></script>
    <script src='https://cdn.jsdelivr.net/npm/@hpcc-js/composite'></script>
    <script src='https://cdn.jsdelivr.net/npm/@hpcc-js/phosphor-shim'></script>
    <script src='https://cdn.jsdelivr.net/npm/@hpcc-js/phosphor'></script>
    <script src='https://cdn.jsdelivr.net/npm/@hpcc-js/codemirror-shim'></script>
    <script src='https://cdn.jsdelivr.net/npm/@hpcc-js/codemirror'></script>
    <script src='https://cdn.jsdelivr.net/npm/@hpcc-js/react'></script>
    <script src='https://cdn.jsdelivr.net/npm/@hpcc-js/graph/dist/index.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@hpcc-js/map'></script>
    <script src='https://cdn.jsdelivr.net/npm/@hpcc-js/other'></script>
    <script src='https://cdn.jsdelivr.net/npm/@hpcc-js/preact-shim'></script>
    <script src='https://cdn.jsdelivr.net/npm/@hpcc-js/timeline'></script>
    <script src='https://cdn.jsdelivr.net/npm/@hpcc-js/tree'></script>
    <script src="https://cdn.jsdelivr.net/npm/faker@5.4.0/dist/faker.js"></script>

    <script>
        window.hpccjs = Object.keys(window).filter(n => n.indexOf('@hpcc-js/') === 0).reduce((o, n) => {
            o[n.split('/')[1]] = window[n];
            return o;
        }, {});
    </script>
    <script src="https://cdn.jsdelivr.net/npm/faker@5.4.0/dist/faker.js"></script>
    <script src="xml_funcs.js"></script>
    
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div id="topnav">
        <div id="logoDiv">App Logo</div>
        <div id="buttonsDiv">
            <div>
                <button id="toggle-leftnav-btn" onclick="toggleLeftnav(this)"><i class="fa fa-angle-double-left"></i></button>
            </div>
            <div id="zoom-label">Zoom</div>
            <div>
                <button onclick="zoomOut()"><i class="fa fa-search-minus"></i></button>
            </div>
            <div>
                <button onclick="zoomIn()"><i class="fa fa-search-plus"></i></button>
            </div>
            <div id="zoom_input_div" style="display:none;">
                <input id="zoom_input" type="text" value="100" />
            </div>
            <div>
                <button onclick="graph.layout('Circle').lazyRender()">Circle</button>
            </div>
            <div>
                <button onclick="graph.layout('ForceDirectedHybrid').lazyRender()">Force Directed</button>
            </div>
            <div>
                <button onclick="graph.layout('ForceDirected2').lazyRender()">Spring</button>
            </div>
            <div id="layout_H">
                <button onclick="graph.layout('Hierarchy').lazyRender()">Hierarchy</button>
            </div>
            <div id="layout_Neato">
                <button onclick="graph.layout('Neato').lazyRender()">Neato</button>
            </div>
            <div id="layout_TwoPI">
                <button onclick="graph.layout('TwoPI').lazyRender()">TwoPI</button>
            </div>
            <div id="layout_Circo">
                <button onclick="graph.layout('Circo').lazyRender()">Circo</button>
            </div>
            <div id="layout_FDP">
                <button onclick="graph.layout('FDP').lazyRender()">FDP</button>
            </div>
            <div id="center_btn">
                <button onclick="graph.zoomToFit()">Center</button>
            </div>
            <!-- <div>
                <button onclick="toggleEdgeText()">Toggle Dates</button>
            </div> -->
            <div id="topright">
                <a href="#download">Download</a>
                |
                <a href="#help">Help?</a>
            </div>
        </div>
    </div>
    <div id="leftnav">
        <div class="section-label">Nodes</div>
        <div id="nodesDiv">
            <label>
                <i class="fa fa-user" style="color:#F6A70B"></i>
                <span>Person</span>
                <input class="filter-checkbox" type="checkbox" value="assoc" checked="checked" oninput="updateFilter()">
            </label>
            <label>
                <i class="fa fa-home" style="color:#AD7B60"></i>
                <span>Addresses</span>
                <input class="filter-checkbox" type="checkbox" value="addr" checked="checked" oninput="updateFilter()">
            </label>
            <label>
                <i class="fa fa-building" style="color:#838383"></i>
                <span>Businesses</span>
                <input class="filter-checkbox" type="checkbox" value="corp" checked="checked" oninput="updateFilter()">
            </label>
            <label>
                <i class="fa fa-car" style="color:#1685D7"></i>
                <span>Vehicles</span>
                <input class="filter-checkbox" type="checkbox" value="veh" checked="checked" oninput="updateFilter()">
            </label>
            <label>
                <i class="fa fa-balance-scale" style="color:#9875C3"></i>
                <span>Criminal Records</span>
                <input class="filter-checkbox" type="checkbox" value="rel" checked="checked" oninput="updateFilter()">
            </label>
            <label>
                <i class="fa fa-dollar-sign" style="color:#67903F"></i>
                <span>Bankruptcies</span>
                <input class="filter-checkbox" type="checkbox" value="air" checked="checked" oninput="updateFilter()">
            </label>
            <label>
                <i class="fa fa-home" style="color:#CE662C"></i>
                <span>Sexual Offenses</span>
                <input class="filter-checkbox" type="checkbox" value="sex" checked="checked" oninput="updateFilter()">
            </label>
            <label>
                <i class="fa fa-home" style="color:#030303"></i>
                <span>Concealed Weapons</span>
                <input class="filter-checkbox" type="checkbox" value="wep" checked="checked" oninput="updateFilter()">
            </label>
            <label>
                <i class="fa fa-home" style="color:#D036C1"></i>
                <span>People at Work</span>
                <input class="filter-checkbox" type="checkbox" value="paw" checked="checked" oninput="updateFilter()">
            </label>
            <label>
                <i class="fa fa-ship" style="color:#1F69C0"></i>
                <span>Vessels</span>
                <input class="filter-checkbox" type="checkbox" value="boat" checked="checked" oninput="updateFilter()">
            </label>
            <label>
                <i class="fa fa-fighter-jet" style="color:#C0B121"></i>
                <span>Aircraft</span>
                <input class="filter-checkbox" type="checkbox" value="air" checked="checked" oninput="updateFilter()">
            </label>
            <label>
                <i class="fa fa-hospital-symbol" style="color:#C62315"></i>
                <span>Health Care Sanctions</span>
                <input class="filter-checkbox" type="checkbox" value="hcs" checked="checked" oninput="updateFilter()">
            </label>
        </div>
        <div class="section-label">Relationships</div>
        <div id="relationshipsDiv">
            <div class="legend-item">
                <div class="legend-color" style="background-color:#9fbbdd"></div>
                <div class="legend-label">Relative</div>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color:#9bcbb8"></div>
                <div class="legend-label">Business</div>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color:#C2B9F8"></div>
                <div class="legend-label">Associate</div>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color:#93d1e6"></div>
                <div class="legend-label">Property</div>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color:#eecb87"></div>
                <div class="legend-label">Resident</div>
            </div>
        </div>
    </div>
    <div id="target"></div>
    <script>
        let SHOW_EDGE_TEXT = false;
        const url = new URL(window.location.href);
        const nodeCount = Number(url.searchParams.get("nodes") ?? 100);
        const linkCount = Number(url.searchParams.get("links") ?? 120);

        const xmlStr = createFakeXML(nodeCount,linkCount);
        const vertexPositionMap = {};
        const data = parseXML(xmlStr);

        const graph = new hpccjs.graph.Graph2();

        graph.vertex_click = function (evt) {
            console.log('arguments === ', arguments);
            console.log('evt === ',evt);
            console.log('evt.buttons === ',evt.buttons);
        }
        document.addEventListener("contextmenu", (evt) => {
            evt.preventDefault();
            evt.stopPropagation();
            
            const cm = document.getElementById("graph_contextmenu");
    
            if(cm){
                cm.remove();
            }
            // 
            // display your custom right click menu here
            //
            const div = document.createElement('div');
            div.id = "graph_contextmenu";
            div.style.border = `1px solid black`;
            div.style.padding = `4px`;
            div.style.width = `200px`;
            div.style.height = `200px`;
            div.style.backgroundColor = `#fff`;
            div.style.position = `fixed`;
            div.style.top = (evt.clientY - 16) + "px";
            div.style.left = (evt.clientX - 16) + "px";
            div.textContent = `context menu content goes here`;
            div.onmouseleave = () => {
                div.remove();
            }
            document.body.appendChild(div);
        });
        console.log('data.categories === ', data.categories);
        let fullData = {...data};
        graph
            .target("target")
            .categories(data.categories)
            .data({
                vertices: data.vertices,
                edges: data.edges
            })
            .edgeArcDepth(0)
            .dragSingleNeighbors(true)
            // potential layouts:
            //"Hierarchy" | "DOT" | "Tree" | "Dendrogram" | "RadialTree" | "RadialDendrogram" 
            // | "ForceDirected" | "ForceDirected2" | "ForceDirectedHybrid" | "Neato" | "FDP" 
            // | "Circle" | "TwoPI" | "Circo" | "None"
            .layout("ForceDirected")
            // .layout("None")
            .applyScaleOnLayout(true)
            .edgeStrokeWidth(2)
            .centroidRenderer(hpccjs.react.Vertex3)
            .vertexRenderer(hpccjs.react.Vertex3)
            .render(() => {
                graph.graphData().allVertices().forEach(v => {
                    const {
                        x,
                        y
                    } = vertexPositionMap[v.id];
                    v.x = x;
                    v.y = y;
                });
                graph.zoomToFit();
            });

        function zoomOut() {
            graph.zoomMinus();
        }

        function zoomIn() {
            graph.zoomPlus();
        }

        function zoomTo(val) {
            graph.zoomToFitLimit(val);
            graph.zoomToFit();
        }
        function toggleEdgeText(){
            SHOW_EDGE_TEXT = !SHOW_EDGE_TEXT;
            graph
                .showEdgeLabels(SHOW_EDGE_TEXT)
                .render()
                ;
        }

        function toggleLeftnav(btn) {
            const isHidden = leftnav.style.display === "none";
            leftnav.style.display = isHidden ? "flex" : "none";
            btn.innerHTML = isHidden ? `<i class="fa fa-angle-double-left"></i>` : `<i class="fa fa-angle-double-right"></i>`;
            target.style.left = isHidden ? `154px` : `8px`;
            graph.resize();
            graph.zoomToFit();
        }

        function updateFilter() {
            const filterCheckboxArr = [...document.querySelectorAll(".filter-checkbox")];
            console.log('filterCheckboxArr === ', filterCheckboxArr);
            const filterMap = filterCheckboxArr.reduce((r,n,i) => {
                r[n.value] = n.checked;
                return r;
            },{});
            graph.graphData().clear();
            graph.graphData().clearParents();
            graph
            .data({vertices:[],edges:[]}, false)
            .render(()=>{
                const _data = {...fullData};
                    const removedIds = {};
                    _data.vertices = _data.vertices.filter(vertex=>{
                        if(filterMap[vertex.metaData.iconType] === false) {
                            removedIds[vertex.entityId] = true;
                            return false;
                        }
                        return true;
                    });
                    _data.edges = _data.edges.filter(edge=>{
                        if(removedIds[edge.source.entityId] || removedIds[edge.target.entityId]){
                            return false;
                        }
                        return true;
                    });
                    graph
                        .data(_data)
                        .render(()=>{
                            graph.graphData().allVertices().forEach(v => {
                                const {x,y} = vertexPositionMap[v.id];
                                v.x = x;
                                v.y = y;
                            });
                            graph.zoomPlus();
                            graph.zoomToFit();
                        })
                        ;
                })
                ;
        }
    </script>
</body>

</html>