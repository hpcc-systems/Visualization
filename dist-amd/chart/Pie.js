(function(e,t){typeof define=="function"&&define.amd?define(["d3","../common/SVGWidget","../api/I2DChart","../common/Text","../common/FAChar","../common/Utility","../api/ITooltip","css!./Pie"],t):e.chart_Pie=t(e.d3,e.common_SVGWidget,e.api_I2DChart,e.common_Text,e.common_FAChar,e.common_Utility,e.api_ITooltip)})(this,function(e,t,n,r,i,s,o){function u(r){t.call(this),n.call(this),o.call(this),s.SimpleSelectionMixin.call(this),this.labelWidgets={},this.d3Pie=e.layout.pie().padAngle(.0025).sort(function(e,t){return e<t?-1:e>t?1:0}).value(function(e){return e[1]}),this.d3Arc=e.svg.arc().padRadius(this.calcRadius()).innerRadius(this.innerRadius()),this.tooltipTick_default(!1).tooltipOffset_default(0)}return u.prototype=Object.create(t.prototype),u.prototype.constructor=u,u.prototype._class+=" chart_Pie",u.prototype.implements(n.prototype),u.prototype.implements(o.prototype),u.prototype.mixin(s.SimpleSelectionMixin),u.prototype.publish("paletteID","default","set","Palette ID",u.prototype._palette.switch(),{tags:["Basic","Shared"]}),u.prototype.publish("useClonedPalette",!1,"boolean","Enable or disable using a cloned palette",null,{tags:["Intermediate","Shared"]}),u.prototype.publish("outerText",!1,"boolean","Sets label position inside or outside chart",null,{tags:["Basic"]}),u.prototype.publish("innerRadius",0,"number","Sets inner pie hole radius as a percentage of the radius of the pie chart",null,{tags:["Basic"]}),u.prototype.pointInArc=function(e,t){var n=this.d3Arc.innerRadius()(t),r=this.d3Arc.outerRadius()(t),i=this.d3Arc.startAngle()(t),s=this.d3Arc.endAngle()(t),o=e.x*e.x+e.y*e.y,u=Math.atan2(e.x,-e.y);return u=u<0?u+Math.PI*2:u,n*n<=o&&o<=r*r&&i<=u&&u<=s},u.prototype.boxInArc=function(e,t,n){var r={x:e.x+t.x,y:e.y+t.y},i={x:r.x+t.width,y:r.y},s={x:r.x,y:r.y+t.height},o={x:r.x+t.width,y:r.y+t.height};return this.pointInArc(r,n)&&this.pointInArc(i,n)&&this.pointInArc(s,n)&&this.pointInArc(o,n)},u.prototype.calcRadius=function(e){return Math.min(this._size.width,this._size.height)/2-2},u.prototype.intersection=function(e,t){return this.intersectCircle(e,t)},u.prototype.enter=function(e,n){t.prototype.enter.apply(this,arguments),this._selection.widgetElement(n);var r=this;this.tooltipHTML(function(e){return r.tooltipFormat({label:e.data[0],value:e.data[1]})})},u.prototype.update=function(n,s){function f(t,n){return function(){e.select(this).transition().delay(n).attrTween("d",function(n){var r=e.interpolate(n.outerRadius,o.calcRadius()+t);return function(e){return n.outerRadius=r(e),o.d3Arc(n)}})}}t.prototype.update.apply(this,arguments);var o=this;this._palette=this._palette.switch(this.paletteID()),this.useClonedPalette()&&(this._palette=this._palette.cloneNotExists(this.paletteID()+"_"+this.id())),this.d3Arc.innerRadius(this.innerRadius_exists()?this.calcRadius()*this.innerRadius()/100:0);var u=s.selectAll(".arc").data(this.d3Pie(this.data()),function(e){return e.data[0]});u.enter().append("g").attr("class","arc").attr("opacity",0).call(this._selection.enter.bind(this._selection)).on("click",function(e){o.click(o.rowToObj(e.data),o.columns()[1],o._selection.selected(this))}).each(function(t){var n=e.select(this);n.append("path").on("mouseout.tooltip",o.tooltip.hide).on("mousemove.tooltip",o.tooltip.show).on("mouseover",f(0,0)).on("mouseout",f(-5,150)),t.data.__viz_faChar?o.labelWidgets[t.data[0]]=(new i).char(t.data.__viz_faChar).target(this).render():o.labelWidgets[t.data[0]]=(new r).text(t.data[0]).target(this).render()}),u.transition().attr("opacity",1).each(function(t){t.outerRadius=o.calcRadius()-5;var n={x:0,y:1};if(o.outerText()){var r=Math.cos((t.startAngle+t.endAngle-Math.PI)/2),i=Math.sin((t.startAngle+t.endAngle-Math.PI)/2),s=o.labelWidgets[t.data[0]].getBBox(),u=Math.abs(r)>Math.abs(i)?s.width:s.height;n.x=r*(o.calcRadius()+u),n.y=i*(o.calcRadius()+u)}else{var a=o.d3Arc.centroid(t);n={x:a[0],y:a[1]}}var f=e.select(this);f.select("path").transition().attr("d",o.d3Arc).style("fill",function(e){return o._palette(e.data[0])}),o.labelWidgets[t.data[0]].pos(n).render().element().classed("innerLabel",!o.outerText()).classed("outerLabel",o.outerText()).style("opacity",o.outerText()||o.boxInArc(n,o.labelWidgets[t.data[0]].getBBox(),t)?null:0)}),u.exit().transition().style("opacity",0).remove();if(o.outerText()){var a=s.selectAll("line").data(this.d3Pie(this.data()),function(e){return e.data[0]});a.enter().append("line").attr("x1",0).attr("x2",0).attr("y1",-this.calcRadius()-3).attr("y2",-this.calcRadius()-8).attr("stroke","gray").attr("transform",function(e){return"rotate("+(e.startAngle+e.endAngle)/2*(180/Math.PI)+")"}),a.transition().attr("transform",function(e){return"rotate("+(e.startAngle+e.endAngle)/2*(180/Math.PI)+")"}),a.exit().remove()}},u.prototype.exit=function(e,n){t.prototype.exit.apply(this,arguments)},u});