!function(t,e){"function"==typeof define&&define.amd?define(["d3","grid-list","../common/HTMLWidget","./Cell","../common/TextBox","../common/Utility","css!./Grid"],e):t.layout_Grid=e(t.d3,t.GridList,t.common_HTMLWidget,t.layout_Cell,t.common_TextBox,t.common_Utility)}(this,function(t,e,i,n,o,r){function s(){i.call(this),this._tag="div",this._selectionBag=new r.Selection,this.content([])}return s.prototype=Object.create(i.prototype),s.prototype.constructor=s,s.prototype._class+=" layout_Grid",s.prototype.publish("designMode",!1,"boolean","Design Mode",null,{tags:["Basic"]}),s.prototype.publish("fitTo","all","set","Sizing Strategy",["all","width"],{tags:["Basic"]}),s.prototype.publish("snapping","vertical","set","Snapping Strategy",["vertical","horizontal","none"]),s.prototype.publish("snappingColumns",12,"number","Snapping Columns"),s.prototype.publish("snappingRows",16,"number","Snapping Rows"),s.prototype.publish("gutter",6,"number","Gap Between Widgets",null,{tags:["Basic"]}),s.prototype.publish("surfaceShadow",!0,"boolean","3D Shadow"),s.prototype.publish("surfacePadding",null,"string","Cell Padding (px)",null,{tags:["Intermediate"]}),s.prototype.publish("surfaceBorderWidth",1,"number","Width (px) of Cell Border",null,{tags:["Intermediate"]}),s.prototype.publish("surfaceBackgroundColor",null,"html-color","Surface Background Color",null,{tags:["Advanced"]}),s.prototype.publish("content",[],"widgetArray","widgets",null,{tags:["Basic"],render:!1}),s.prototype.getDimensions=function(){var t={width:0,height:0};return this.content().forEach(function(e){t.width<e.gridCol()+e.gridColSpan()&&(t.width=e.gridCol()+e.gridColSpan()),t.height<e.gridRow()+e.gridRowSpan()&&(t.height=e.gridRow()+e.gridRowSpan())},this),t},s.prototype.clearContent=function(t){this.content(this.content().filter(function(e){if(!t)return e.target(null),!1;for(var i=e;i;){if(t===i)return e.target(null),!1;i=i.widget?i.widget():null}return!0}))},s.prototype.setContent=function(t,e,i,o,r,s){if(r=r||1,s=s||1,o=o||"",this.content(this.content().filter(function(i){return i.gridRow()===t&&i.gridCol()===e?(i.target(null),!1):!0})),i){var l=(new n).gridRow(t).gridCol(e).widget(i).title(o).gridRowSpan(r).gridColSpan(s);this.content().push(l)}return this},s.prototype.sortedContent=function(){return this.content().sort(function(t,e){return t.gridRow()===e.gridRow()?t.gridCol()-e.gridCol():t.gridRow()-e.gridRow()})},s.prototype.getCell=function(t,e){var i=null;return this.content().some(function(n){return t>=n.gridRow()&&t<n.gridRow()+n.gridRowSpan()&&e>=n.gridCol()&&e<n.gridCol()+n.gridColSpan()?(i=n,!0):!1}),i},s.prototype.getWidgetCell=function(t){var e=null;return this.content().some(function(i){return i.widget()._id===t?(e=i,!0):!1}),e},s.prototype.getContent=function(t){var e=null;return this.content().some(function(i){return i.widget()._id===t?(e=i.widget(),!0):!1}),e},s.prototype.cellToGridItem=function(t){return{x:t.gridCol(),y:t.gridRow(),w:t.gridColSpan(),h:t.gridRowSpan(),id:t.id(),cell:t}},s.prototype.gridItemToCell=function(t){t.cell.gridCol(t.x).gridRow(t.y).gridColSpan(t.w).gridRowSpan(t.h)},s.prototype.resetItemsPos=function(){this.origItems.forEach(function(t){var e=this.itemsMap[t.id];e.x=t.x,e.y=t.y},this)},s.prototype.initGridList=function(){this.itemsMap={},this.items=this.content().map(function(t){var e=this.cellToGridItem(t);return this.itemsMap[e.id]=e,e},this),this.origItems=this.content().map(this.cellToGridItem),this.gridList=new e(this.items,{direction:this.snapping(),lanes:"horizontal"===this.snapping()?this.snappingRows():this.snappingColumns()})},s.prototype.killGridList=function(){this.gridList=null,delete this.items,delete this.itemsMap},s.prototype.enter=function(e,n){i.prototype.enter.apply(this,arguments),this._scrollBarWidth=this.getScrollbarWidth();var o=this;this._d3Drag=t.behavior.drag().origin(function(t){var e=o.cellToGridItem(t);return{x:e.x*o.cellWidth,y:e.y*o.cellHeight}}).on("dragstart",function(e){if(o.designMode()){t.event.sourceEvent.stopPropagation(),o.initGridList();var i=o.itemsMap[e.id()];o.dragItem=n.append("div").attr("class","dragging").style("transform",function(){return"translate("+i.x*o.cellWidth+"px, "+i.y*o.cellHeight+"px)"}).style("width",function(){return i.w*o.cellWidth-o.gutter()+"px"}).style("height",function(){return i.h*o.cellHeight-o.gutter()+"px"}),o.selectionBagClick(e)}}).on("drag",function(e){if(o.designMode()){t.event.sourceEvent.stopPropagation();var i=o.itemsMap[e.id()];t.event.x<0&&(t.event.x=0),t.event.x+i.w*o.cellWidth>o.snappingColumns()*o.cellWidth&&(t.event.x=o.snappingColumns()*o.cellWidth-i.w*o.cellWidth),t.event.y<0&&(t.event.y=0),t.event.y+i.h*o.cellWidth>o.snappingRows()*o.cellWidth&&(t.event.y=o.snappingRows()*o.cellWidth-i.h*o.cellWidth);var n=[Math.max(0,Math.floor((t.event.x+o.cellWidth/2)/o.cellWidth)),Math.max(0,Math.floor((t.event.y+o.cellHeight/2)/o.cellHeight))];(i.x!==n[0]||i.y!==n[1])&&("none"!==o.snapping()?(o.resetItemsPos(),o.gridList.moveItemToPosition(i,n)):(i.x=n[0],i.y=n[1]),(e.gridCol()!==i.x||e.gridRow()!==i.y)&&(o.items.forEach(o.gridItemToCell),o.updateGrid(!1,100))),o.dragItem.style("transform",function(){return"translate("+t.event.x+"px, "+t.event.y+"px)"}).style("width",function(){return i.w*o.cellWidth+"px"}).style("height",function(){return i.h*o.cellHeight+"px"})}}).on("dragend",function(){o.designMode()&&(t.event.sourceEvent.stopPropagation(),o.dragItem.remove(),o.dragItem=null,o.killGridList())}),this._d3DragResize=t.behavior.drag().origin(function(t){var e=o.cellToGridItem(t);return{x:(e.x+e.w-1)*o.cellWidth,y:(e.y+e.h-1)*o.cellHeight}}).on("dragstart",function(e){if(o.designMode()){t.event.sourceEvent.stopPropagation(),o.initGridList();var i=o.itemsMap[e.id()];o.dragItem=n.append("div").attr("class","resizing").style("transform",function(){return"translate("+i.x*o.cellWidth+"px, "+i.y*o.cellHeight+"px)"}).style("width",function(){return i.w*o.cellWidth-o.gutter()+"px"}).style("height",function(){return i.h*o.cellHeight-o.gutter()+"px"}),o.dragItemPos={x:i.x,y:i.y}}}).on("drag",function(e){if(o.designMode()){t.event.sourceEvent.stopPropagation();var i=o.itemsMap[e.id()],n=[Math.max(0,Math.round(t.event.x/o.cellWidth)),Math.max(0,Math.round(t.event.y/o.cellHeight))],r={w:Math.max(1,n[0]-i.x+1),h:Math.max(1,n[1]-i.y+1)};(i.w!==r.w||i.h!==r.h)&&("none"!==o.snapping()?(o.resetItemsPos(),o.gridList.resizeItem(i,r)):(i.w=r.w,i.h=r.h),(e.gridColSpan()!==i.w||e.gridRowSpan()!==i.h)&&(o.items.forEach(o.gridItemToCell),o.updateGrid(i.id,100))),o.dragItem.style("width",function(){return(-i.x+1)*o.cellWidth+t.event.x-o.gutter()+"px"}).style("height",function(){return(-i.y+1)*o.cellHeight+t.event.y-o.gutter()+"px"})}}).on("dragend",function(){o.designMode()&&(t.event.sourceEvent.stopPropagation(),o.dragItem.remove(),o.dragItem=null,o.killGridList())})},s.prototype.updateGrid=function(t,e,i){e=e||0;var n=this;this.divItems.classed("draggable",this.designMode()).transition().duration(e).style("left",function(t){return t.gridCol()*n.cellWidth+n.gutter()/2+"px"}).style("top",function(t){return t.gridRow()*n.cellHeight+n.gutter()/2+"px"}).style("width",function(t){return t.gridColSpan()*n.cellWidth-n.gutter()+"px"}).style("height",function(t){return t.gridRowSpan()*n.cellHeight-n.gutter()+"px"}).each("end",function(e){e.surfaceShadow_default(n.surfaceShadow()).surfacePadding_default(n.surfacePadding()).surfaceBorderWidth_default(n.surfaceBorderWidth()).surfaceBackgroundColor_default(n.surfaceBackgroundColor()),(t===!0||t===e.id())&&e.resize().lazyRender()})},s.prototype.update=function(e,n){i.prototype.update.apply(this,arguments),this._parentElement.style("overflow-x","width"===this.fitTo()?"hidden":null),this._parentElement.style("overflow-y","width"===this.fitTo()?"scroll":null);var o=this.getDimensions(),r=this.width()-("width"===this.fitTo()?this._scrollBarWidth:0);if(this.cellWidth=r/o.width,this.cellHeight="all"===this.fitTo()?this.height()/o.height:this.cellWidth,this.designMode()){var s=Math.min(this.width()/this.snappingColumns(),this.height()/this.snappingRows()),l=Math.floor(s);this.cellWidth=l,this.cellHeight=this.cellWidth}var a=this;this.divItems=n.selectAll("#"+this.id()+" > .ddCell").data(this.content(),function(t){return t.id()}),this.divItems.enter().append("div").attr("class","ddCell").call(this._d3Drag).each(function(e){e.target(this),e.__grid_watch=e.monitor(function(t,i,n){!a._renderCount||"snapping"!==t&&0!==t.indexOf("grid")||i===n||a.gridList||(a.initGridList(),"none"!==a.snapping()&&a.gridList.resizeGrid("horizontal"===a.snapping()?a.snappingRows():a.snappingColumns()),a.items.forEach(a.gridItemToCell),a.updateGrid(e.id(),100),a.killGridList())});var i=t.select(this);i.append("div").attr("class","resizeHandle").call(a._d3DragResize).append("div").attr("class","resizeHandleDisplay")}),this.divItems.select(".resizeHandle").style("display",this.designMode()?null:"none"),this.updateGrid(!0),this.divItems.exit().each(function(t){t.target(null),t.__grid_watch&&t.__grid_watch.remove()}).remove();var d=n.selectAll("#"+this.id()+" > .laneBackground").data(this.designMode()?[""]:[]);d.enter().insert("div",":first-child").attr("class","laneBackground").style("left","1px").style("top","1px").on("click",function(){a.selectionBagClear()}),d.style("width",this.snappingColumns()*this.cellWidth+"px").style("height",this.snappingRows()*this.cellWidth+"px"),d.exit().each(function(t){a.selectionBagClear()}).remove();var h=n.selectAll("#"+this.id()+" > .lane").data(this.designMode()?[""]:[]);h.enter().append("div").attr("class","lane").style("left","1px").style("top","1px"),h.style("width",this.snappingColumns()*this.cellWidth+"px").style("height",this.snappingRows()*this.cellWidth+"px").style("background-image","linear-gradient(to right, grey 1px, transparent 1px), linear-gradient(to bottom, grey 1px, transparent 1px)").style("background-size",this.cellWidth+"px "+this.cellHeight+"px"),h.exit().remove()},s.prototype.exit=function(t,e){i.prototype.exit.apply(this,arguments)},s.prototype._createSelectionObject=function(t){return{_id:t._id,element:function(){return t._element},widget:t}},s.prototype.selection=function(t){return arguments.length?(this._selectionBag.set(t.map(function(t){return this._createSelectionObject(t)},this)),this):this._selectionBag.get().map(function(t){return t._id})},s.prototype.selectionBagClear=function(){this._selectionBag.isEmpty()||(this._selectionBag.clear(),this.postSelectionChange())},s.prototype.selectionBagClick=function(e){if(null!==e){var i=this._createSelectionObject(e);t.event.sourceEvent.ctrlKey?this._selectionBag.isSelected(i)?(this._selectionBag.remove(i),this.postSelectionChange()):(this._selectionBag.append(i),this.postSelectionChange()):(this._selectionBag.set([i]),this.postSelectionChange())}},s.prototype.postSelectionChange=function(){},s});