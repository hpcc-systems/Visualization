(function(e,t){typeof define=="function"&&define.amd?define(["d3","../common/SVGWidget","../common/TextBox","../common/Surface","../common/ResizeSurface","../chart/MultiChartSurface","../common/Palette","../graph/Graph","../graph/Vertex","../graph/Edge","./HipieDDL"],t):e.marshaller_Graph=t(e.d3,e.common_SVGWidget,e.common_TextBox,e.common_Surface,e.common_ResizeSurface,e.chart_MultiChartSurface,e.common_Palette,e.graph_Graph,e.graph_Vertex,e.graph_Edge,e.marshaller_HipieDDL)})(this,function(e,t,n,r,i,s,o,u,a,f,l){function c(e,t,s){function d(e,t,n,r,i,s){r=r||"",i=i||"",s=s||"",t&&n&&e.vertexMap[t]&&e.vertexMap[n]?e.edges.push((new f).sourceVertex(e.vertexMap[t]).targetVertex(e.vertexMap[n]).sourceMarker(r).targetMarker(i).text(s)):(e.vertexMap[t]||console.log("Unknown Vertex:  "+t),e.vertexMap[n]||console.log("Unknown Vertex:  "+n))}t instanceof Object||t&&(t=JSON.parse(t));var u=null,c={},h={},p=[];return e.accept({_visualizeRoxie:s,visit:function(e){if(e instanceof l.Dashboard)u={dashboard:e,vertexMap:h,edges:p},c[e.getQualifiedID()]=u;else if(e instanceof l.DataSource){e.databomb&&t[e.id]&&e.comms.databomb(t[e.id]);if(this._visualizeRoxie){var s="";e.filter.forEach(function(e){s.length>0&&(s+=", "),s+=e}),s=" ("+s+")",u.vertexMap[e.getQualifiedID()]=(new a).class("vertexLabel").faChar("").text(e.id+s)}}else if(e instanceof l.Output)e.dataSource.databomb&&e.dataSource.comms.databombOutput(e.from),this._visualizeRoxie&&(u.vertexMap[e.getQualifiedID()]=(new a).class("vertexLabel").faChar("").text(e.id+"\n["+e.from+"]"));else if(e instanceof l.Visualization&&e.widget){var f=null;if(e.widget instanceof r)f=e.widget.size({width:210,height:210});else if(e.widget instanceof n)f=e.widget;else{var d=280,v=210;e.type==="GRAPH"&&(d=800,v=600),f=(new i).size({width:d,height:v}).title(e.title).content(e.widget)}if(f){e.widgetSurface=f,u.vertexMap[e.getQualifiedID()]=f;switch(e.type){case"2DCHART":case"PIE":case"BUBBLE":case"BAR":case"WORD_CLOUD":f.menu(e.widget._2DChartTypes.concat(e.widget._NDChartTypes.concat(e.widget._anyChartTypes)).map(function(e){return e.display}).sort()),f._menu.click=function(t){e.widget.chartType(t).render()};break;case"LINE":f.menu(e.widget._NDChartTypes.concat(e.widget._anyChartTypes).map(function(e){return e.display}).sort()),f._menu.click=function(t){e.widget.chartType(t).render()};break;case"CHORO":f._menu.data(o.rainbow()),f._menu.click=function(e){f._content.paletteID(e).render(e)};break;case"GRAPH":f._menu.data(["Circle","ForceDirected","ForceDirected2","Hierarchy"]),f._menu.click=function(e){f._content.layout(e)}}}}}}),u=null,e.accept({_visualizeRoxie:s,visit:function(e){e instanceof l.Dashboard?u=c[e.getQualifiedID()]:e instanceof l.DataSource||(e instanceof l.Output?this._visualizeRoxie&&d(u,e.dataSource.getQualifiedID(),e.getQualifiedID(),"circleFoot","circleHead"):e instanceof l.Visualization&&(this._visualizeRoxie&&(e.source.getDatasource()&&d(u,e.getQualifiedID(),e.source.getDatasource().getQualifiedID(),"","arrowHead","update"),e.source.getOutput()&&d(u,e.source.getOutput().getQualifiedID(),e.getQualifiedID(),"","arrowHead","notify")),e.events.getUpdates().forEach(function(t){d(u,e.getQualifiedID(),t.visualization.getQualifiedID(),undefined,"arrowHead","on "+t.eventID)})))}}),c}function p(){u.call(this),this._design_mode=!1,this._dashboards=[],this.graphAttributes=["snapToGrid","showEdges"],this.widgetAttributes=["layout","chartType","palette","title","columns","data"]}var h=2;return p.prototype=Object.create(u.prototype),p.prototype.constructor=p,p.prototype._class+=" marshaller_Graph",p.prototype.publish("ddlUrl","","string","DDL URL",null,{tags:["Private"]}),p.prototype.publish("databomb","","string","Data Bomb",null,{tags:["Private"]}),p.prototype.publish("visualizeRoxie",!1,"boolean","Show Roxie Data Sources",null,{tags:["Private"]}),p.prototype.publish("proxyMappings",{},"object","Proxy Mappings",null,{tags:["Private"]}),p.prototype.design_mode=function(e){return arguments.length?(this._design_mode=e,this.showEdges(this._designMode).snapToGrid(this._designMode?12:0).allowDragging(this._designMode),this.data().vertices&&this.data().vertices.forEach(function(e){e.show_title(this._design_mode).render()},this),this):this._design_mode},p.prototype.dashboards=function(e){return arguments.length?(this._dashboards=e,this):this._dashboards},p.prototype.title=function(){var e="";return this._dashboards.forEach(function(t){e&&(e+=", "),e+=t.dashboard.title}),e},p.prototype.renderDashboards=function(e){this.data({vertices:[],edges:[]});var t=[],n=[];for(var r in this._dashboards){for(var i in this._dashboards[r].vertexMap)t.push(this._dashboards[r].vertexMap[i]);n=n.concat(this._dashboards[r].edges)}this.data({vertices:t,edges:n});var s=e?this.load():{changed:!1,dataChanged:!1};return s.changed&&this.layout(""),s.dataChanged||this.fetchData(),this},p.prototype.fetchData=function(){for(var e in this._dashboards){var t=this._dashboards[e].dashboard;for(var n in t.datasources)t.datasources[n].fetchData({},!0)}return this},p.prototype.checksum=function(e){var t=0,n=e.length,r,i;if(n===0)return t;for(r=0;r<n;r++)i=e.charCodeAt(r),t=(t<<5)-t+i,t&=t;return t},p.prototype.calcHash=function(){var e=this,t=h;for(var n in this._dashboards){var r=this._dashboards[n].dashboard;r.accept({visit:function(n){n instanceof l.Visualization&&(t+=e.checksum(n.getQualifiedID()))}})}return t},p.prototype.clear=function(){localStorage.setItem("Graph_"+this.calcHash(),"")},p.prototype.serialize=function(e,t){e=e||[],t=t||[];var n={};n.zoom={translation:this.zoom.translate(),scale:this.zoom.scale()},e.forEach(function(e){this[e]&&(n[e]=this[e]())},this);for(var r in this._dashboards){var i=this._dashboards[r].dashboard,s=i.getQualifiedID();n[s]={},i.accept({visit:function(e){if(e instanceof l.Visualization&&e.widgetSurface){var r={pos:e.widgetSurface.pos(),size:e.widgetSurface.size()};t.forEach(function(t){e.widget[t]?r[t]=e.widget[t]():e.widgetSurface[t]&&(r[t]=e.widgetSurface[t]())}),n[s][e.getQualifiedID()]=r}}})}return JSON.stringify(n)},p.prototype.save=function(){localStorage.setItem("Graph_"+this.calcHash(),this.serialize(this.graphAttributes,this.widgetAttributes))},p.prototype.deserialize=function(e,t,n){t=t||[],n=n||[];var r=!1,i=!1;t.forEach(function(t){this[t]&&e[t]!==undefined&&this[t](e[t])},this),e.zoom&&(this.setZoom(e.zoom.translation,e.zoom.scale),r=!0);for(var s in this._dashboards){var o=this._dashboards[s].dashboard,u=o.getQualifiedID();o.accept({visit:function(t){if(t instanceof l.Visualization&&e[u]&&e[u][t.getQualifiedID()]){var s=e[u][t.getQualifiedID()];t.widgetSurface.pos(s.pos).size(s.size),r=!0,n.forEach(function(e){t.widget[e]&&s[e]!==undefined?(t.widget[e](s[e]),e==="data"&&(i=!0)):t.widgetSurface[e]&&s[e]&&t.widgetSurface[e](s[e])})}}})}return{changed:r,dataChanged:i}},p.prototype.load=function(){var e={changed:!1,dataChanged:!1},t=localStorage.getItem("Graph_"+this.calcHash());return t&&(e=this.deserialize(JSON.parse(t),this.graphAttributes,this.widgetAttributes)),e},p.prototype.enter=function(e,t){u.prototype.enter.apply(this,arguments),t.classed("graph_Graph",!0)},p.prototype.update=function(e,t){u.prototype.update.apply(this,arguments)},p.prototype.render=function(e){function r(){var r=c(n,t.databomb(),t.visualizeRoxie());t.dashboards(r),t.applyScaleOnLayout(!0).layout("Hierarchy").renderDashboards(!0),u.prototype.render.call(t,function(t){e&&e(t)})}if(this.ddlUrl()===""||this.ddlUrl()===this._prev_ddlUrl&&this.databomb()===this._prev_databomb&&this._prev_visualizeRoxie===this.visualizeRoxie())return u.prototype.render.apply(this,arguments);this._prev_ddlUrl=this.ddlUrl(),this._prev_databomb=this.databomb(),this._prev_visualizeRoxie=this.visualizeRoxie();var t=this,n=(new l.Marshaller).proxyMappings(this.proxyMappings()).on("commsError",function(e,n){t.commsError(e,n)});return this.ddlUrl()[0]==="["||this.ddlUrl()[0]==="{"?n.parse(this.ddlUrl(),function(){r()}):n.url(this.ddlUrl(),function(){r()}),this},p.prototype.commsError=function(e,t){alert("Comms Error:\n"+e+"\n"+t)},p});