(function(e,t){typeof define=="function"&&define.amd?define(["d3","../layout/Grid","./HipieDDL","../layout/Surface","../layout/Cell","../layout/Popup","../other/Persist","./FlyoutButton"],t):e.marshaller_HTML=t(e.d3,e.layout_Grid,e.marshaller_HipieDDL,e.layout_Surface,e.layout_Cell,e.layout_Popup,e.other_Persist,e.marshaller_FlyoutButton)})(this,function(e,t,n,r,i,s,o,u){function a(){t.call(this),this.surfacePadding(0)}function f(e,t){t instanceof Object||t&&(t=JSON.parse(t));var r=null,i={};return e.accept({visit:function(e){e instanceof n.Dashboard?(r={dashboard:e,visualizations:[]},i[e.getQualifiedID()]=r):e instanceof n.DataSource?e.databomb&&t[e.id]&&e.comms.databomb(t[e.id]):e instanceof n.Output?e.dataSource.databomb&&e.dataSource.comms.databombOutput(e.from,e.id):e instanceof n.Visualization&&e.widget&&r.visualizations.push(e)}}),i}return a.prototype=Object.create(t.prototype),a.prototype.constructor=a,a.prototype._class+=" marshaller_HTML",a.prototype.publish("ddlUrl","","string","DDL URL",null,{tags:["Private"]}),a.prototype.publish("databomb","","string","Data Bomb",null,{tags:["Private"]}),a.prototype.publish("proxyMappings",{},"object","Proxy Mappings",null,{tags:["Private"]}),a.prototype.publish("clearDataOnUpdate",!0,"boolean","Clear data prior to refresh",null),a.prototype.publish("propogateClear",!1,"boolean","Propogate clear to dependent visualizations",null),a.prototype.publish("missingDataString","***MISSING***","string","Missing data display string"),a.prototype.enter=function(e,n){t.prototype.enter.apply(this,arguments),this.popupContainer=n.append("div").classed("popup-container",!0).style({height:"100px",position:"absolute","z-index":1e3})},a.prototype.render=function(i){function h(){var e=f(c.marshaller,c.databomb());for(var n in e){var s=[],o=[];e[n].visualizations.forEach(function(e,t){l.remove(e.id),e.properties.flyout?s.push(e):o.push(e)}),l.forEach(function(e,t){c.clearContent(t)});var a=0,h=0,p=c.cellDensity(),d=Math.floor(Math.sqrt(o.length));o.forEach(function(e,t){if(!c.marshaller.widgetMappings().get(e.id)){var n=null;e.widget instanceof r||e.widget.classID()==="composite_MegaChart"?n=e.widget:n=(new r).widget(e.widget),e.widget.size({width:0,height:0}),n.title(e.title);while(c.getCell(a*p,h*p)!==null)h++,h%d===0&&(a++,h=0);c.setContent(a,h,n)}}),s.forEach(function(e,t){var n=e.events.getUpdatesVisualizations();n.forEach(function(t){switch(t.widget.classID()){case"composite_MegaChart":var n=(new u).title(e.title).widget(e.widget);t.widget.toolbarWidgets().push(n)}})})}var v={};c.content().forEach(function(e){var t=e.widget();t&&t.classID()==="layout_Surface"&&(t=t.widget()),t&&(v[t.id()]=e)});for(n in e)e[n].visualizations.forEach(function(e,t){if(e.properties.flyout)return;var n=e.events.getUpdatesVisualizations(),r=n.map(function(e){return v[e.id].id()});v[e.id].indicateTheseIds(r)});t.prototype.render.call(c,function(t){for(var n in e)for(var r in e[n].dashboard.datasources)e[n].dashboard.datasources[r].fetchData({},!0);var s=0,o=setInterval(function(){if(c.marshaller.commsDataLoaded()||++s>120)clearInterval(o),i&&i(t)},500)})}if(this.ddlUrl()===""||this.ddlUrl()===this._prev_ddlUrl&&this.databomb()===this._prev_databomb)return this.marshaller&&this.marshaller.proxyMappings(this.proxyMappings()).clearDataOnUpdate(this.clearDataOnUpdate()).propogateClear(this.propogateClear()).missingDataString(this.missingDataString()),t.prototype.render.apply(this,arguments);this._prev_ddlUrl&&this._prev_ddlUrl!==this.ddlUrl()&&this.clearContent(),this._prev_ddlUrl=this.ddlUrl(),this._prev_databomb=this.databomb();var s=[];o.widgetArrayWalker(this.content(),function(e){s.push(e)});var a=e.map(s,function(e){return e.id()}),l=e.map(s.filter(function(e){return e.id().indexOf(e._idSeed)!==0&&e.id().indexOf("_pe")!==0}),function(e){return e.id()}),c=this;return this.marshaller=(new n.Marshaller).proxyMappings(this.proxyMappings()).clearDataOnUpdate(this.clearDataOnUpdate()).propogateClear(this.propogateClear()).missingDataString(this.missingDataString()).widgetMappings(a).on("commsError",function(e,t){c.commsError(e,t)}),this.ddlUrl()[0]==="["||this.ddlUrl()[0]==="{"?this.marshaller.parse(this.ddlUrl(),function(){h()}):this.marshaller.url(this.ddlUrl(),function(){h()}),this},a.prototype.commsError=function(e,t){alert("Comms Error:\n"+e+"\n"+t)},a});