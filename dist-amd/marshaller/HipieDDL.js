(function(e,t){typeof define=="function"&&define.amd?define(["d3","../common/Class","../common/Database","../common/Utility","../other/Comms","../common/Widget","require","es6-promise"],t):e.marshaller_HipieDDL=t(e.d3,e.common_Class,e.common_Database,e.common_Utility,e.other_Comms,e.common_Widget,e.require)})(this,function(e,t,n,r,i,s,o){function f(e,t){var n=e.split("."),r=t;for(var i=0;i<n.length;++i){var s=n[i];if(!r||r[s]===undefined)return!1;r=r[s]}return!0}function l(e){return e?String.fromCharCode(parseInt(e)):e}function c(e,t){this.visualization=e;var n={};for(var r in t)t[r]instanceof Array?t[r].forEach(function(e,t){n[t===0?r:r+"_"+t]=e}):n[r]=t[r];this.mappings=n,this.hasMappings=!1,this.reverseMappings={},this.columns=[],this.columnsIdx={},this.columnsRHS=[],this.columnsRHSIdx={}}function h(e){switch(e){case"bool":case"boolean":return"boolean";case"integer":case"float":case"double":return"number";case"date":case"time":return"time";case"geohash":return"geohash";default:if(e.indexOf("unsigned")===0)return"number"}return"string"}function p(e,t){c.call(this,e,t),this.columns=["label","weight"],this.columnsIdx={label:0,weight:1},this.init()}function d(e,t){c.call(this,e,t),t.state?(this.columns=["state","weight"],this.columnsIdx={state:0,weight:1}):t.county?(this.columns=["county","weight"],this.columnsIdx={county:0,weight:1}):t.geohash&&(this.columns=["geohash","weight"],this.columnsIdx={geohash:0,weight:1}),this.init()}function v(e,t){c.call(this,e,t),t.state?(this.columns=["state"],this.columnsIdx={state:0}):t.county?(this.columns=["county"],this.columnsIdx={county:0}):t.geohash&&(this.columns=["geohash","label"],this.columnsIdx={geohash:0,label:1});var n=this.columns.length;t.weight.forEach(function(e,t){this.columns.push(e),this.columnsIdx[t===0?"weight":"weight_"+t]=t+n},this),this.init()}function m(e,t){c.call(this,e,t),this.columns=["x","y","weight"],this.columnsIdx={x:0,y:1,weight:2},this.init()}function g(e,t){var n={label:t.x[0]};t.y.forEach(function(e,t){n[e]=e}),c.call(this,e,n),this.init()}function y(e,t){var n={};for(var r in t)t[r].forEach(function(t,r){n[e.label[r]]=t});c.call(this,e,n),this.init()}function b(e,t,n){c.call(this,e,t),this.icon=e.icon||{},this.fields=e.fields||{},this.columns=["uid","label","weight","flags"],this.columnsIdx={uid:0,label:1,weight:2,flags:3},this.init(),this.link=n,this.linkMappings=new c(e,this.link.mappings),this.linkMappings.columns=["uid"],this.linkMappings.columnsIdx={uid:0},this.visualization=e}function w(e,t){this.visualization=e;if(t){this._id=t.id,this._output=t.output,this.mappings=null,t.mappings||console.log("no mappings for:"+e.id+"->"+t.id);switch(this.visualization.type){case"LINE":this.mappings=new g(this.visualization,t.mappings);break;case"TABLE":this.mappings=new y(this.visualization,t.mappings);break;case"GRAPH":this.mappings=new b(this.visualization,t.mappings,t.link);break;case"CHORO":t.mappings.weight instanceof Array&&t.mappings.weight.length?(this.mappings=new v(this.visualization,t.mappings,t.link),t.mappings.weight.length>1&&(this.visualization.type="LINE")):this.mappings=new d(this.visualization,t.mappings,t.link);break;case"HEAT_MAP":this.mappings=new m(this.visualization,t.mappings,t.link);break;default:this.mappings=new p(this.visualization,t.mappings)}this.first=t.first,this.reverse=t.reverse,this.sort=t.sort}}function E(e,t,n){this.visualization=e,this.eventID=t,n&&(this._updates=n.updates,this.mappings=n.mappings)}function S(e,t){this.visualization=e,this.events={};for(var n in t)this.events[n]=new E(e,n,t[n])}function x(e,n,r){t.call(this),this.dashboard=e,this.parentVisualization=r,this.id=n.id,this.label=n.label,this.title=n.title||n.id,this.type=n.type,this.icon=n.icon||{},this.flag=n.flag||[],this.fields=n.fields||{},this.properties=n.properties||(n.source?n.source.properties:null)||{},this.source=new w(this,n.source),this.events=new S(this,n.events),this.layers=(n.visualizations||[]).map(function(t){return new x(e,t,this)},this);var i=this;switch(this.type){case"CHORO":var s=n.properties&&n.properties.charttype?n.properties.charttype:"";switch(s){case"MAP_PINS":this.loadWidget("../map/Pins",function(e){e.id(n.id).columns(i.source.getColumns()).geohashColumn("geohash").tooltipColumn("label").fillColor(n.color?n.color:null).projection("albersUsaPr")});break;default:s="CHORO_USSTATES",this.source.mappings.contains("state")?s="CHORO_USSTATES":this.source.mappings.contains("county")?s="CHORO_USCOUNTIES":this.source.mappings.contains("country")&&(s="CHORO_COUNTRIES"),Promise.all(i.layers.map(function(e){return e.loadedPromise()})).then(function(){i.loadWidget("../composite/MegaChart",function(e){var t=i.layers.map(function(e){return e.widget});e.id(n.id).legendPosition_default("none").showChartSelect_default(!1).chartType_default(s).chartTypeDefaults({autoScaleMode:t.length?"data":"mesh"}).chartTypeProperties({layers:t})})})}break;case"2DCHART":case"PIE":case"BUBBLE":case"BAR":case"WORD_CLOUD":this.loadWidget("../composite/MegaChart",function(e){e.id(n.id).legendPosition_default("none").chartType_default(i.properties.chartType||i.properties.charttype||i.type)});break;case"LINE":this.loadWidget("../composite/MegaChart",function(e){e.id(n.id).legendPosition_default("none").chartType_default(i.properties.chartType||i.properties.charttype||i.type)});break;case"TABLE":this.loadWidget("../composite/MegaChart",function(e){e.id(n.id).legendPosition_default("none").showChartSelect_default(!1).chartType_default("TABLE").chartTypeDefaults({pagination:!0})});break;case"SLIDER":this.loadWidget("../form/Slider",function(e){e.id(n.id);if(n.range){var t="";for(var r in n.events.events.mappings){t=r;break}e.low_default(+n.range[0]).high_default(+n.range[1]).step_default(+n.range[2]).selectionLabel_default(t)}});break;case"GRAPH":this.loadWidgets(["../graph/Graph"],function(e){e.id(n.id).layout_default("ForceDirected2").applyScaleOnLayout_default(!0)});break;case"FORM":this.loadWidgets(["../form/Form","../form/Input","../form/Button","../form/CheckBox","../form/ColorInput","../form/Radio","../form/Range","../form/Select","../form/Slider","../form/TextArea"],function(e,t){var r=t[1],i=t[3],s=t[5],o=t[7],u=t[9];e.id(n.id).inputs(n.fields.map(function(e){var t=[],n=[],a;switch(e.properties.charttype){case"TEXT":a=(new r).type_default("text");break;case"TEXTAREA":a=new u;break;case"CHECKBOX":a=new i;break;case"RADIO":a=new s;break;case"HIDDEN":a=(new r).type_default("hidden");break;default:if(e.properties.enumvals){a=new o,n=e.properties.enumvals;for(var f in n)t.push([f,n[f]])}else a=(new r).type_default("text")}a.name_default(e.id).label_default((e.properties?e.properties.label:null)||e.label).value_default(e.properties.default?e.properties.default:"");if(a instanceof i||a instanceof s){var l=Object.keys(e.properties.enumvals);a.selectOptions_default(l)}else t.length&&a.selectOptions_default(t);return a}))});break;case"HEAT_MAP":this.loadWidgets(["../other/HeatMap"],function(e){e.id(n.id).image_default(i.properties.imageUrl)});break;default:this.loadWidget("../common/TextBox",function(e){e.id(n.id).text_default(i.id+"\n"+"TODO:  "+i.type)})}}function T(e,t){this.dataSource=e,this.id=t.id,this.from=t.from,this.request={},this.notify=t.notify||[],this.filter=t.filter||[]}function N(e,t,n){this.dashboard=e,this.id=t.id,this.filter=t.filter||[],this.WUID=t.WUID,this.URL=t.URL,this.databomb=t.databomb,this.request={},this._loadedCount=0;var r=this;this.outputs={};var s=[];t.outputs.forEach(function(e){r.outputs[e.id]=new T(r,e),s.push({id:e.id,from:e.from,filter:e.filter||this.filter})},this),this.WUID?this.comms=(new i.HIPIEWorkunit).url(e.marshaller.espUrl._url).proxyMappings(n).hipieResults(s):this.databomb?this.comms=(new i.HIPIEDatabomb).hipieResults(s):this.comms=(new i.HIPIERoxie).url(t.URL).proxyMappings(n)}function C(e,t,n){this.marshaller=e,this.id=t.id,this.title=t.title;var r=this;this.datasources={},this.datasourceTotal=0,t.datasources.forEach(function(e){r.datasources[e.id]=new N(r,e,n),++r.datasourceTotal}),this._visualizations={},this._visualizationArray=[],t.visualizations.forEach(function(e){var t=new x(this,e);this._visualizations[e.id]=t,this._visualizationArray.push(t),this.marshaller._visualizations[e.id]=t,this.marshaller._visualizationArray.push(t)},this),this._visualizationTotal=this._visualizationArray.length}function k(){t.call(this),this._proxyMappings={},this._widgetMappings=e.map(),this._clearDataOnUpdate=!0,this._propogateClear=!1,this.id="Marshaller",this._missingDataString=""}var u="...loading...",a="_changed";return c.prototype.init=function(){for(var e in this.mappings)this.reverseMappings[this.mappings[e]]=e,this.columnsIdx[e]===undefined&&(this.columns.push(e),this.columnsIdx[e]=this.columns.length-1),this.columnsRHS[this.columnsIdx[e]]=this.mappings[e],this.columnsRHSIdx[this.mappings[e]]=this.columnsIdx[e],this.hasMappings=!0},c.prototype.getFields=function(){return this.visualization.fields?Object.keys(this.mappings).map(function(e){return this.visualization.fields.filter(function(t){return t.id===this.mappings[e]},this).map(function(e){return(new n.Field(e.id)).type(h(e.properties.type)).label(this.reverseMappings[e.id])},this)[0]},this):null},c.prototype.contains=function(e){return this.mappings[e]!==undefined},c.prototype.doMap=function(e){var t=[];for(var n in this.mappings){var r=this.mappings[n];try{var i=e[r];i===undefined&&(i=e[r.toLowerCase()]),t[this.columnsIdx[n]]=i}catch(s){console.log("Invalid Mapping:  "+this.visualization.id+" ["+r+"->"+e+"]")}}return t},c.prototype.doMapAll=function(e){return e.hipieMappings(this.columnsRHS,this.visualization.dashboard.marshaller.missingDataString())},c.prototype.getMap=function(e){return this.mappings[e]},c.prototype.getReverseMap=function(e){return this.reverseMappings[e]},p.prototype=Object.create(c.prototype),d.prototype=Object.create(c.prototype),v.prototype=Object.create(c.prototype),m.prototype=Object.create(c.prototype),g.prototype=Object.create(c.prototype),y.prototype=Object.create(c.prototype),y.prototype.init=function(){this.visualization.label.forEach(function(e,t){this.reverseMappings[this.mappings[e]]=e,this.columns.push(e),this.columnsIdx[e]=t,this.columnsRHS[t]=this.mappings[e],this.columnsRHSIdx[this.mappings[e]]=t,this.hasMappings=!0},this)},b.prototype=Object.create(c.prototype),b.prototype.calcIconInfo=function(e,t,n){function i(e,t){if(e)for(var r in e)switch(r){case"faChar":t.faChar=l(e.faChar);break;case"tooltip":t[r]=e[r];break;case"icon_image_colorFill":case"icon_shape_colorFill":case"icon_shape_colorStroke":n?t[r.split("icon_")[1]]=e[r]:t[r]=e[r];break;case"textbox_image_colorFill":case"textbox_shape_colorFill":case"textbox_shape_colorStroke":n||(t[r]=e[r]);break;case"id":case"valuemappings":case"font":case"charttype":break;default:console.log("Unknown annotation property:  "+r)}}var r={};if(t&&t[e.fieldid]&&e.valuemappings){var s=e.valuemappings[t[e.fieldid]];i(s,r)}for(var o in r)return r;return null},b.prototype.doMapAll=function(e){function o(e,t){var o="uid_"+e[0],u=r[o];if(!u&&t){u=(new s.Vertex).faChar(n.icon&&n.icon.faChar?l(n.icon.faChar):"ï„¨").text(e[1]?e[1]:""),u.__hpcc_uid=e[0],r[o]=u,i.push(u);var a=n.calcIconInfo(n.visualization.icon,t,!1);if(a)for(var f in a)u[f]&&u[f](a[f]);var c=[];n.visualization.flag.forEach(function(e){var r=n.calcIconInfo(e,t,!0);r&&c.push(r)}),u.annotationIcons(c)}return u}var t=e.jsonObj(),n=this,r={},i=[],s=this.visualization.widget,u=[];return t.forEach(function(e){var t=n.doMap(e);o(t,e)}),t.forEach(function(e){var t=n.doMap(e),r=o(t,e);if(e[n.link.childfile]&&e[n.link.childfile].Row){var i=e[n.link.childfile].Row;i.forEach(function(e,t){var i=n.linkMappings.doMap(e),a=o(i);if(a&&r.id()!==a.id()){var f=(new s.Edge).sourceVertex(r).targetVertex(a).sourceMarker("circleFoot").targetMarker("arrowHead");u.push(f)}})}}),{vertices:i,edges:u,merge:!1}},w.prototype.getQualifiedID=function(){return this.visualization.getQualifiedID()+"."+this.id},w.prototype.exists=function(){return this._id},w.prototype.getDatasource=function(){return this.visualization.dashboard.datasources[this._id]},w.prototype.getOutput=function(){var e=this.getDatasource();return e&&e.outputs?e.outputs[this._output]:null},w.prototype.hasData=function(){return this.getOutput().db?!0:!1},w.prototype.getFields=function(){return this.mappings.getFields()},w.prototype.getColumns=function(){return this.mappings&&this.mappings.columns?this.mappings.columns:[]},w.prototype.getData=function(){var e=this.getOutput().db,t=e.data();t.length&&this.sort&&r.multiSort(t,e.hipieMapSortArray(this.sort));var n=this.mappings.doMapAll(e);return this.reverse&&n.reverse(),this.first&&n.length>this.first&&(n.length=this.first),n},w.prototype.getXTitle=function(){return this.mappings.columns[0]},w.prototype.getYTitle=function(){return this.mappings.columns.filter(function(e,t){return t>0}).join(" / ")},E.prototype.exists=function(){return this._updates!==undefined},E.prototype.getUpdates=function(){var e=[];return f("_updates",this)&&this._updates instanceof Array&&this._updates.forEach(function(t,n){var r=this.visualization.dashboard.datasources[t.datasource],i=this.visualization.dashboard.getVisualization(t.visualization);e.push({eventID:this.eventID,datasource:r,visualization:i})},this),e},E.prototype.getUpdatesDatasources=function(){var e={},t=[];return this.getUpdatesVisualizations().forEach(function(n,r){var i=n.source.getDatasource();i&&!e[i.id]&&(e[i.id]=!0,t.push(i))},this),t},E.prototype.getUpdatesVisualizations=function(){var e={},t=[];return f("_updates",this)&&this._updates instanceof Array&&this._updates.forEach(function(n,r){var i=this.visualization.dashboard.getVisualization(n.visualization);e[i.id]||(e[i.id]=!0,t.push(i))},this),t},S.prototype.setWidget=function(e){var t=this;for(var n in this.events)e["vertex_"+n]?e["vertex_"+n]=function(e){t.visualization.processEvent(n,t.events[n],e)}:e[n]&&(e[n]=function(e,r,i){t.visualization.processEvent(n,t.events[n],e,r,i)})},S.prototype.exists=function(){return this._updates!==undefined},S.prototype.getUpdates=function(){var e=[];for(var t in this.events)e=e.concat(this.events[t].getUpdates());return e},S.prototype.getUpdatesDatasources=function(){var e=[];for(var t in this.events)e=e.concat(this.events[t].getUpdatesDatasources());return e},S.prototype.getUpdatesVisualizations=function(){var e=[];for(var t in this.events)e=e.concat(this.events[t].getUpdatesVisualizations());return e},x.prototype=Object.create(t.prototype),x.prototype.constructor=x,x.prototype.getQualifiedID=function(){return this.id},x.prototype.loadedPromise=function(){var e=this;return new Promise(function(t,n){var r=setInterval(function(){e.isLoaded()&&(clearInterval(r),t())},100)})},x.prototype.isLoading=function(){return this.widget===null},x.prototype.isLoaded=function(){return this.widget instanceof s},x.prototype.loadWidget=function(e,t){this.loadWidgets([e],t)},x.prototype.loadWidgets=function(e,t){this.widget=null;var n=this;o(e,function(e){var r=n.dashboard.marshaller._widgetMappings.get(n.id);r?(e.prototype._class!==r._class&&console.log("Unexpected persisted widget type (old persist string?)"),n.setWidget(r)):n.setWidget(new e),t&&t(n.widget,arguments)})},x.prototype.setWidget=function(e){this.widget=e,this.events.setWidget(e);var t=this.source.getColumns();this.widget.columns(t);for(var n in this.properties)switch(e.classID()){case"chart_MultiChart":case"composite_MegaChart":e.chartTypeDefaults()[n]=this.properties[n];break;default:if(this.widget[n+"_default"])try{this.widget[n+"_default"](this.properties[n])}catch(r){console.log("Invalid Property:"+this.id+".properties."+n)}}return this.widget},x.prototype.accept=function(e){e.visit(this)},x.prototype.update=function(e){if(!e){var t={},n=this.getInputVisualizations();n.forEach(function(e){for(var n in e._eventValues)t[n]=!0});var r=[],i=this.source.getDatasource();for(var s in i.request)t[s]&&r.push(i.request[s]);e=r.join(", ")}var o=null;if(!this.parentVisualization){o=this.widget;while(o&&!o.title)o=o.locateParentWidget()}if(o){var u=o.title(),a=u.split(" (");o.title(a[0]+(e?" ("+e+")":"")).render()}else this.widget.render()},x.prototype.notify=function(){if(this.source.hasData()&&this.widget){var e=this.source.getData();this.widget.data(e),this.update()}},x.prototype.clear=function(){this.widget&&this.dashboard.marshaller.clearDataOnUpdate()&&(this.widget.data([]),this.source.getOutput().request={}),this.dashboard.marshaller.propogateClear()&&this._eventValues&&(delete this._eventValues,this.events.getUpdatesVisualizations().forEach(function(e){e.clear()})),this.update(u)},x.prototype.on=function(e,t){var n=this;return this.overrideMethod(e,function(e,r){e.apply(n,r),setTimeout(function(){t.apply(n,r)},0)}),this},x.prototype.processEvent=function(e,t,n,r,i){var s=this;setTimeout(function(){i=i===undefined?!0:i;if(t.exists()){var e={};if(i)for(var r in t.mappings){var o=s.source.mappings&&s.source.mappings.hasMappings?s.source.mappings.getReverseMap(r):r;e[t.mappings[r]]=n[o]}s._eventValues=e;var u={},f=t.getUpdatesVisualizations();f.forEach(function(e){var t=e.source.getDatasource();u[t.id]||(u[t.id]={datasource:t,request:{},updates:[]}),u[t.id].updates.push(e.id),e.getInputVisualizations().forEach(function(e,n){if(e._eventValues)for(var r in e._eventValues){var i=e===s;u[t.id].request[r]&&u[t.id].request[r]!==e._eventValues[r]?(console.log("Duplicate Filter with mismatched value (defaulting to 'first' or 'first changed' instance):  "+r),i&&(u[t.id].request[r]=e._eventValues[r],u[t.id].request[r+a]=i)):(u[t.id].request[r]=e._eventValues[r],u[t.id].request[r+a]=i)}}),e.type!=="GRAPH"&&e.clear(),(t.WUID||t.databomb)&&t.fetchData(u[t.id].request,!1,[e.id])});for(var l in u)!u[l].datasource.WUID&&!u[l].datasource.databomb&&u[l].datasource.fetchData(u[l].request,!1,u[l].updates)}},0)},x.prototype.getInputVisualizations=function(){return this.dashboard.marshaller.getVisualizationArray().filter(function(e){var t=e.events.getUpdatesVisualizations();return t.indexOf(this)>=0?!0:!1},this)},x.prototype.serializeState=function(){return{eventValues:this._eventValues}},x.prototype.deserializeState=function(e){if(!e)return;this._eventValues=e.eventValues},T.prototype.getQualifiedID=function(){return this.dataSource.getQualifiedID()+"."+this.id},T.prototype.accept=function(e){e.visit(this)},T.prototype.vizNotify=function(e){this.notify.filter(function(t){return!e||e.indexOf(t)>=0}).forEach(function(e){var t=this.dataSource.dashboard.getVisualization(e);t.notify()},this)},T.prototype.setData=function(e,t,r){this.request=t,this.db=(new n.Grid).jsonObj(e),this.vizNotify(r)},N.prototype.getQualifiedID=function(){return this.dashboard.getQualifiedID()+"."+this.id},N.prototype.accept=function(e){e.visit(this);for(var t in this.outputs)this.outputs[t].accept(e)},N.prototype.fetchData=function(e,t,n){if(e&&e.refresh!==undefined)throw"refresh in this request????";e=e||this.request||{},t=t||!1;if(!n){n=[];for(var r in this.outputs){var i=this.outputs[r];i.notify.forEach(function(e){var t=this.dashboard.getVisualization(e),r=t.getInputVisualizations();r.length||(n.push(e),t.update(u))},this)}}var s=this;this.request.refresh=t,this.filter.forEach(function(t){this.request[t+a]=e[t+a]||!1;var n=e[t]===undefined?null:e[t];this.request[t]!==n&&(this.request[t]=n)},this),window.__hpcc_debug&&console.log("fetchData:  "+JSON.stringify(n)+"("+JSON.stringify(e)+")");for(var o in this.request)this.request[o]===null&&delete this.request[o];var f=Date.now();return this.dashboard.marshaller.commsEvent(this,"request",this.request),new Promise(function(t,r){s.comms.call(s.request).then(function(r){var i=500-(Date.now()-f);setTimeout(function(){s.processResponse(r,e,n),s.dashboard.marshaller.commsEvent(s,"response",s.request,r),++s._loadedCount,t(r)},i>0?i:0)}).catch(function(e){s.dashboard.marshaller.commsEvent(s,"error",s.request,e),r(e)})})},N.prototype.processResponse=function(e,t,n){var r={};for(var i in e)r[i.toLowerCase()]=e[i];for(var s in this.outputs){var o=this.outputs[s].from;o||(o=this.outputs[s].id.toLowerCase());if(f(o,e))!f(o+a,e)||f(o+a,e)&&e[o+a].length&&e[o+a][0][o+a]?this.outputs[s].setData(e[o],t,n):this.outputs[s].vizNotify(n);else if(f(o,r))console.log("DDL 'DataSource.From' case is Incorrect"),!f(o+a,r)||f(o+a,r)&&e[o+a].length&&r[o+a][0][o+a]?this.outputs[s].setData(r[o],t,n):this.outputs[s].vizNotify(n);else{var u=[];for(var l in e)u.push(l);console.log("Unable to locate '"+o+"' in response {"+u.join(", ")+"}")}}},N.prototype.serializeState=function(){return{request:this.request}},N.prototype.deserializeState=function(e){if(!e)return;this.request=e.request||{}},C.prototype.loadedPromise=function(){return Promise.all(this._visualizationArray.map(function(e){return e.loadedPromise()}))},C.prototype.getQualifiedID=function(){return this.id},C.prototype.getVisualization=function(e){return this._visualizations[e]||this.marshaller.getVisualization(e)},C.prototype.getVisualizations=function(){return this._visualizations},C.prototype.getVisualizationArray=function(){return this._visualizationArray},C.prototype.getVisualizationTotal=function(){return this._visualizationTotal},C.prototype.accept=function(e){e.visit(this);for(var t in this.datasources)this.datasources[t].accept(e);this._visualizationArray.forEach(function(t){t.accept(e)},this)},C.prototype.fetchData=function(){var e=[];for(var t in this.datasources)e.push(this.datasources[t].fetchData());return Promise.all(e)},C.prototype.serializeState=function(){var e={datasources:{},visualizations:{}};for(var t in this.datasources)e.datasources[t]=this.datasources[t].serializeState();for(var n in this._visualizations)e.visualizations[n]=this._visualizations[n].serializeState();return e},C.prototype.deserializeState=function(e){if(!e)return;for(var t in this.datasources)e.datasources[t]&&this.datasources[t].deserializeState(e.datasources[t]);for(var n in this._visualizations)e.visualizations[n]&&this._visualizations[n].deserializeState(e.visualizations[n])},k.prototype=Object.create(t.prototype),k.prototype.constructor=k,k.prototype.commsDataLoaded=function(){for(var e=0;e<this.dashboardArray.length;e++)for(var t in this.dashboardArray[e].datasources)if(this.dashboardArray[e].datasources[t]._loadedCount===0)return!1;return!0},k.prototype.getVisualization=function(e){return this._visualizations[e]},k.prototype.accept=function(e){e.visit(this),this.dashboardTotal=0;for(var t in this.dashboards)this.dashboards[t].accept(e),++this.dashboardTotal},k.prototype.url=function(e,t){this.espUrl=(new i.ESPUrl).url(e);var n=null,r="HIPIE_DDL";this.espUrl.isWorkunitResult()?(r=this.espUrl._params.ResultName,n=(new i.HIPIEWorkunit).url(e).proxyMappings(this._proxyMappings)):n=(new i.HIPIERoxie).url(e).proxyMappings(this._proxyMappings);var s={refresh:!1},o=this;n.call(s).then(function(e){if(f(r,e))return n.fetchResult(r).then(function(n){var i=n[0][r];o.parse(i,function(){t(e)})}).catch(function(e){o.commsEvent(o,"error",r,e)})}).catch(function(e){o.commsEvent(o,"error",s,e)})},k.prototype.proxyMappings=function(e){return arguments.length?(this._proxyMappings=e,this):this._proxyMappings},k.prototype.widgetMappings=function(e){return arguments.length?(this._widgetMappings=e,this):this._widgetMappings},k.prototype.clearDataOnUpdate=function(e){return arguments.length?(this._clearDataOnUpdate=e,this):this._clearDataOnUpdate},k.prototype.propogateClear=function(e){return arguments.length?(this._propogateClear=e,this):this._propogateClear},k.prototype.missingDataString=function(e){return arguments.length?(this._missingDataString=e,this):this._missingDataString},k.prototype.parse=function(e,t){var n=this;return this._json=e,this._jsonParsed=JSON.parse(this._json),this.dashboards={},this.dashboardArray=[],this._visualizations={},this._visualizationArray=[],this._jsonParsed.forEach(function(e){var t=new C(n,e,n._proxyMappings);n.dashboards[e.id]=t,n.dashboardArray.push(t)}),this.dashboardTotal=this.dashboardArray.length,this._visualizationArray.forEach(function(e){e.on("processEvent",function(t,r,i,s,o){n.vizEvent(e.widget,t,i,s,o)})}),this.ready(t),this},k.prototype.dashboardsLoaded=function(){return Promise.all(this.dashboardArray.map(function(e){return e.loadedPromise()}))},k.prototype.getVisualizations=function(){return this._visualizations},k.prototype.getVisualizationArray=function(){return this._visualizationArray},k.prototype.on=function(e,t){var n=this;return this.overrideMethod(e,function(e,r){e.apply(n,r),t.apply(this,arguments)}),this},k.prototype.ready=function(e){if(!e)return;this.dashboardsLoaded().then(function(){e()})},k.prototype.vizEvent=function(e,t,n,r,i){console.log("Marshaller.vizEvent:  "+e.id()+"-"+t)},k.prototype.commsEvent=function(e,t,n,r){switch(t){case"request":window.__hpcc_debug&&console.log("Marshaller.commsEvent:  "+e.id+"-"+t+":  "+JSON.stringify(n));break;case"response":case"error":window.__hpcc_debug&&console.log("Marshaller.commsEvent:  "+e.id+"-"+t+":  "+JSON.stringify(r));break;default:window.__hpcc_debug&&console.log("Marshaller.commsEvent:  "+JSON.stringify(arguments))}},k.prototype.createDatabomb=function(){var e={};return this.dashboardArray.forEach(function(t){for(var n in t.datasources){var r=t.datasources[n].comms;e[n]={};for(var i in r._hipieResults){var s=r._hipieResults[i];e[n][i]=r._resultNameCache[s.from]}}}),e},k.prototype.fetchData=function(){var e=this.dashboardArray.map(function(e){return e.fetchData()});return Promise.all(e)},k.prototype.serializeState=function(){var e={};return this.dashboardArray.forEach(function(t,n){e[t.id]=t.serializeState()}),e},k.prototype.deserializeState=function(e){if(!e)return;return this.dashboardArray.forEach(function(t,n){t.deserializeState(e[t.id])}),this},{exists:f,Marshaller:k,Dashboard:C,DataSource:N,Output:T,Visualization:x}});