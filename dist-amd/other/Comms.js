(function(e,t){typeof define=="function"&&define.amd?define([],t):e.other_Comms=t()})(this,function(){function e(e){if(!e.trim)return e;var t=e.trim();return t!==""&&!isNaN(t)?Number(t):t}function t(t){for(var n in t)t[n]=e(t[n]);return t}function n(){this._protocol="http:",this._hostname="localhost"}function r(e){this._mappings=e,this._reverseMappings={};for(var t in this._mappings){this._reverseMappings[t]={};for(var n in this._mappings[t])this._reverseMappings[t][this._mappings[t][n]]=n}}function i(){n.call(this),this._proxyMappings={},this._mappings=new r({})}function s(e,t){var n=e.split("."),r=t;for(var i=0;i<n.length;++i){var s=n[i];if(r[s]===undefined)return!1;r=r[s]}return!0}function u(){i.call(this)}function a(){i.call(this),this._port="8002",this._target="",this._query=""}function f(){i.call(this),this._port="8010",this._wuid="",this._jobname="",this._sequence=null,this._resultName=null,this._resultNameCache={},this._resultNameCacheCount=0}function l(){i.call(this),this._port="8010",this._wuid=null}function c(){i.call(this)}function h(){f.call(this),this._hipieResults={}}function p(){h.call(this)}n.prototype.url=function(e){if(!arguments.length)return this._url;this._url=e;var t=document.createElement("a");t.href=this._url;var n={};if(t.search.length){var r=t.search;r[0]==="?"&&(r=r.substring(1)),r=r.split("&"),r.map(function(e){var t=e.split("=");n[decodeURIComponent(t[0])]=decodeURIComponent(t[1])})}this._protocol=t.protocol,this._hostname=t.hostname,this._port=t.port,this._pathname=t.pathname;while(this._pathname.length&&this._pathname[0]==="/")this._pathname=this._pathname.substring(1);return this._search=t.search,this._params=n,this._hash=t.hash,this._host=t.host,this},n.prototype.protocol=function(e){return arguments.length?(this._protocol=e,this):this._protocol},n.prototype.hostname=function(e){return arguments.length?(this._hostname=e,this):this._hostname},n.prototype.port=function(e){return arguments.length?(this._port=e,this):this._port},n.prototype.pathname=function(e){return arguments.length?(this._pathname=e,this):this._pathname},n.prototype.isWsWorkunits=function(){return this._pathname.toLowerCase().indexOf("wsworkunits")>=0||this._params.Wuid},n.prototype.isWorkunitResult=function(){return this.isWsWorkunits()&&(this._params.Sequence||this._params.ResultName)},n.prototype.isWsEcl=function(){return this._pathname.toLowerCase().indexOf("wsecl")>=0||this._params.QuerySetId&&this._params.Id},n.prototype.isWsWorkunits_GetStats=function(){return this._pathname.toLowerCase().indexOf("wsworkunits/wugetstats")>=0&&this._params.WUID},n.prototype.getUrl=function(e){return e=e||{},(e.protocol?e.protocol:this._protocol)+"//"+(e.hostname?e.hostname:this._hostname)+":"+(e.port?e.port:this._port)+"/"+(e.pathname?e.pathname:this._pathname)},r.prototype.contains=function(e,t){return s(e+"."+t,this._mappings)},r.prototype.mapResult=function(e,t){var n=this._mappings[t];n&&(e[t]=e[t].map(function(e){var t=[];if(n.x&&n.x instanceof Array){t=[];for(var r=0;r<n.x.length;++r)t.push(e[n.y[r]])}else for(var i in n)n[i]==="label"?t[0]=e[i]:n[i]==="weight"&&(t[1]=e[i]);return t},this))},r.prototype.mapResponse=function(e){for(var t in e)this.mapResult(e,t)},i.prototype=Object.create(n.prototype);var o=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")};return i.prototype.jsonp=function(e,t,r){function d(e){delete window[c],document.body.removeChild(h),r(e)}for(var i in this._proxyMappings){var s=e.split(i),u=s[0];if(s.length>1){var a=(new n).url(e);e=u+this._proxyMappings[i],t.IP=a._hostname,t.PORT=a._port,s.length>0&&(t.PATH=s[1]);break}}var f=6e4,l=5e3,c="jsonp_callback_"+Math.round(Math.random()*999999);window[c]=function(e){f=0,d(e)};var h=document.createElement("script");h.src=e+(e.indexOf("?")>=0?"&":"?")+"jsonp="+c+"&"+o(t),document.body.appendChild(h);var p=setInterval(function(){f<=0?clearInterval(p):(f-=l,f<=0?(clearInterval(p),console.log("Request timeout:  "+h.src),d()):console.log("Request pending ("+f/1e3+" sec):  "+h.src))},l)},i.prototype.mappings=function(e){return arguments.length?(this._mappings=new r(e),this):this._mappings},i.prototype.proxyMappings=function(e){return arguments.length?(this._proxyMappings=e,this):this._proxyMappings},u.prototype=Object.create(i.prototype),u.prototype.cacheCalls=function(e){return arguments.length?(this._cacheCalls=e,this):this._cacheCalls},u.prototype.call=function(e,t){function r(e,t){var r=new XMLHttpRequest;r.open("GET",n,!0),r.onload=function(e){t(JSON.parse(r.responseText))},r.onerror=function(e){t({})},r.send(null)}var n=this._url+(this._url.indexOf("?")>=0?"&":"?")+o(e);if(this._cacheCalls){var i=localStorage.getItem("hpcc.viz."+n);i&&i!==null?setTimeout(function(){t(JSON.parse(i))},0):r(e,function(e){localStorage.setItem("hpcc.viz."+n,JSON.stringify(e)),t(e)})}else localStorage.removeItem("hpcc.viz."+n),r(e,t)},a.prototype=Object.create(i.prototype),a.prototype.url=function(e){var t=i.prototype.url.apply(this,arguments);if(arguments.length){this._port=this._port==="8010"?"8002":this._port;for(var n in this._params)switch(n){case"QuerySetId":this.target(this._params[n]);break;case"Id":this.query(this._params[n])}var r,s;!this._target&&!this._query&&(r=this._pathname.split("/res/"),r.length>=2&&(s=r[1].split("/"),s.length>=3&&(this.target(s[1]),this.query(s[2])))),!this._target&&!this._query&&(r=this._pathname.split("/forms/default/"),r.length>=2&&(s=r[1].split("/"),s.length>=3&&(this.target(s[1]),this.query(s[2]))))}return t},a.prototype.target=function(e){return arguments.length?(this._target=e,this):this._target},a.prototype.query=function(e){return arguments.length?(this._query=e,this):this._query},a.prototype.constructUrl=function(){return i.prototype.getUrl.call(this,{pathname:"WsEcl/submit/query/"+this._target+"/"+this._query+"/json"})},a.prototype.call=function(e,n,r){e=e||{},e.target=e.target||this._target,e.query=e.query||this._query;var i=this,s=this.getUrl({pathname:"WsEcl/submit/query/"+e.target+"/"+e.query+"/json"});this.jsonp(s,n,function(e){for(var n in e){e=e[n].Results;break}for(n in e)e[n]=e[n].Row.map(t);i._mappings.mapResponse(e),r(e)})},a.prototype.send=function(e,t){this.call({target:this._target,query:this._query},e,t)},f.prototype=Object.create(i.prototype),f.prototype.url=function(e){var t=i.prototype.url.apply(this,arguments);if(arguments.length){for(var n in this._params)switch(n){case"Wuid":this.wuid(this._params[n]);break;case"ResultName":this.resultName(this._params[n]);break;case"Sequence":this.sequence(this._params[n])}if(!this._wuid){var r=this._url.split("/res/");if(r.length>=2){var s=r[1].split("/");this.wuid(s[0])}}}return t},f.prototype.wuid=function(e){return arguments.length?(this._wuid=e,this):this._wuid},f.prototype.jobname=function(e){return arguments.length?(this._jobname=e,this):this._jobname},f.prototype.sequence=function(e){return arguments.length?(this._sequence=e,this):this._sequence},f.prototype.resultName=function(e){return arguments.length?(this._resultName=e,this):this._resultName},f.prototype.appendParam=function(e,t,n){return t?(n&&(n+="&"),n+e+"="+t):n},f.prototype.constructUrl=function(){var e=i.prototype.getUrl.call(this,{pathname:"WsWorkunits/res/"+this._wuid+"/"}),t="";return t=this.appendParam("ResultName",this._resultName,t),e+(t?"?"+t:"")},f.prototype._fetchResult=function(e,n,r){e=e||{},e._start=e._start||0,e._count=e._count||-1;var i=this.getUrl({pathname:"WsWorkunits/WUResult.json"}),s={Wuid:e.wuid,ResultName:e.resultname,SuppressXmlSchema:!0,Start:e._start,Count:e._count};this._resultNameCache[e.resultname]={};var o=this;this.jsonp(i,s,function(i){for(var s in i){if(!i[s].Result)throw"No result found.";o._total=i[s].Total,i=i[s].Result;for(var u in i){i=i[u].Row.map(t);break}break}o._resultNameCache[e.resultname]=i,r||o._mappings.mapResult(o._resultNameCache,e.resultname),n(o._resultNameCache[e.resultname])})},f.prototype.fetchResult=function(e,t,n){if(e.wuid)this._fetchResult(e,t,n);else if(e.jobname){var r=this;this.WUQuery(e,function(i){e.wuid=i[0].Wuid,r._fetchResult(e,t,n)})}},f.prototype.WUQuery=function(e,t){var n=this.getUrl({pathname:"WsWorkunits/WUQuery.json"}),r={Jobname:r.jobname,Count:1};this._resultNameCache={},this._resultNameCacheCount=0,this.jsonp(n,r,function(e){if(!s("WUQueryResponse.Workunits.ECLWorkunit",e))throw"No workunit found.";e=e.WUQueryResponse.Workunits.ECLWorkunit,t(e)})},f.prototype.fetchResultNames=function(e){var t=this.getUrl({pathname:"WsWorkunits/WUInfo.json"}),n={Wuid:this._wuid,TruncateEclTo64k:!0,IncludeExceptions:!1,IncludeGraphs:!1,IncludeSourceFiles:!1,IncludeResults:!0,IncludeResultsViewNames:!1,IncludeVariables:!1,IncludeTimers:!1,IncludeResourceURLs:!1,IncludeDebugValues:!1,IncludeApplicationValues:!1,IncludeWorkflows:!1,IncludeXmlSchemas:!1,SuppressResultSchemas:!0};this._resultNameCache={},this._resultNameCacheCount=0;var r=this;this.jsonp(t,n,function(t){s("WUInfoResponse.Workunit.Results.ECLResult",t)&&(t.WUInfoResponse.Workunit.Results.ECLResult.map(function(e){r._resultNameCache[e.Name]=[],++r._resultNameCacheCount}),e(r._resultNameCache))})},f.prototype.fetchResults=function(e,t){var n=this;this.fetchResultNames(function(r){var i=n._resultNameCacheCount;if(i>0)for(var s in n._resultNameCache)n.fetchResult({wuid:n._wuid,resultname:s},function(t){--i<=0&&e(n._resultNameCache)},t);else e(n._resultNameCache)})},f.prototype.postFilter=function(e,t){var n={};for(var r in t)n[r]=t[r].filter(function(t,n){for(var r in e)if(t[r]!==undefined&&e[r]!==undefined&&t[r]!==e[r])return!1;return!0});return this._mappings.mapResponse(n),n},f.prototype.send=function(e,t){var n=this;this._resultNameCacheCount?t(n.postFilter(e,this._resultNameCache)):this.fetchResults(function(r){t(n.postFilter(e,r))},!0)},l.prototype=Object.create(i.prototype),l.prototype.url=function(e){var t=i.prototype.url.apply(this,arguments);if(arguments.length)for(var n in this._params)switch(n){case"WUID":this.wuid(this._params[n])}return t},l.prototype.wuid=function(e){return arguments.length?(this._wuid=e,this):this._wuid},l.prototype.constructUrl=function(){return i.prototype.getUrl.call(this,{pathname:"WsWorkunits/WUGetStats?WUID="+this._wuid})},l.prototype.send=function(e,t){var n=this.getUrl({pathname:"WsWorkunits/WUGetStats.json?WUID="+this._wuid});this.jsonp(n,e,function(e){s("WUGetStatsResponse.Statistics.WUStatisticItem",e)?t(e.WUGetStatsResponse.Statistics.WUStatisticItem):t([])})},c.prototype=Object.create(i.prototype),c.prototype.fetchResults=function(e,n){var r=this.getUrl({});this._resultNameCache={},this._resultNameCacheCount=0;var i=this;this.jsonp(r,e,function(e){for(var r in e){e=e[r].Results;break}for(r in e)e.Exception&&e.Exception.forEach(function(e){console.log("Server Exception:  "+JSON.stringify(e))}),e[r].Row&&(i._resultNameCache[r]=e[r].Row.map(t),++i._resultNameCacheCount);n(i._resultNameCache)})},c.prototype.fetchResult=function(e,t){t(this._resultNameCache[e])},c.prototype.call=function(e,t){this.fetchResults(e,t)},h.prototype=Object.create(f.prototype),h.prototype.hipieResults=function(e){if(!arguments.length)return this._hipieResults;this._hipieResultsLength=0,this._hipieResults={};var t=this;return e.forEach(function(e){t._hipieResultsLength++,t._hipieResults[e.id]=e}),this},h.prototype.fetchResults=function(e){var t=this;return f.prototype.fetchResultNames.call(this,function(n){var r=t._hipieResultsLength;if(r>0)for(var i in t._hipieResults){var s=t._hipieResults[i];t.fetchResult(s.from,function(n){--r<=0&&e(t._resultNameCache)})}else e(t._resultNameCache)})},h.prototype.fetchResult=function(e,t){return f.prototype.fetchResult.call(this,{wuid:this._wuid,resultname:e},function(e){t(e)})},h.prototype.call=function(e,t){if(e.refresh||!this._resultNameCache||!this._resultNameCacheCount)this.fetchResults(t);else{var n={};for(var r in e)e[r]&&e[r+"_changed"]!==undefined&&(n[r]=e[r]);var i={};for(var s in this._hipieResults){var o=this._hipieResults[s],u=!0;for(var a in n)if(o.filter.indexOf(a)<0){u=!1;break}u&&(i[o.from]=this._resultNameCache[o.from].filter(function(e){for(var t in n)if(e[t]!==n[t]&&e[t.toLowerCase()]!==n[t])return!1;return!0}))}t(i)}},p.prototype=Object.create(h.prototype),p.prototype.databomb=function(e){return arguments.length?(this._databomb=e.map(t),this):this._databomb},p.prototype.databombOutput=function(e){return arguments.length?(this._resultNameCacheCount++,this._resultNameCache[e]=this._databomb,this):undefined},p.prototype.fetchResults=function(e){var t=this;setTimeout(function(){e(t._resultNameCache)},0)},{Basic:u,ESPMappings:r,ESPUrl:n,WsECL:a,WsWorkunits:f,HIPIERoxie:c,HIPIEWorkunit:h,HIPIEDatabomb:p,createESPConnection:function(e){e=e||document.URL;var t=(new n).url(e);return t.isWsWorkunits_GetStats()?(new l).url(e):t.isWsWorkunits()?(new f).url(e):t.isWsEcl()?(new a).url(e):null}}});