(function(e,t){typeof define=="function"&&define.amd?define([],t):e.other_Comms=t()})(this,function(){function e(){this._protocol="http:",this._hostname="localhost"}function t(e){this._mappings=e,this._reverseMappings={};for(var t in this._mappings){this._reverseMappings[t]={};for(var n in this._mappings[t])this._reverseMappings[t][this._mappings[t][n]]=n}}function n(){e.call(this),this._proxyMappings={},this._mappings=new t({})}function s(){n.call(this)}function o(){n.call(this),this._port="8002",this._target="",this._query=""}function u(){n.call(this),this._port="8010",this._wuid="",this._jobname="",this._sequence=null,this._resultName=null,this._resultNameCache={},this._resultNameCacheCount=0}function a(){n.call(this),this._port="8010",this._wuid=null}function f(){n.call(this)}function l(){u.call(this),this._hipieResults={}}function c(){l.call(this)}e.prototype.url=function(e){if(!arguments.length)return this._url;this._url=e;var t=document.createElement("a");t.href=this._url;var n={};if(t.search.length){var r=t.search;r[0]==="?"&&(r=r.substring(1)),r=r.split("&"),r.map(function(e){var t=e.split("=");n[decodeURIComponent(t[0])]=decodeURIComponent(t[1])})}this._protocol=t.protocol,this._hostname=t.hostname,this._port=t.port,this._pathname=t.pathname;while(this._pathname.length&&this._pathname[0]==="/")this._pathname=this._pathname.substring(1);return this._search=t.search,this._params=n,this._hash=t.hash,this._host=t.host,this},e.prototype.protocol=function(e){return arguments.length?(this._protocol=e,this):this._protocol},e.prototype.hostname=function(e){return arguments.length?(this._hostname=e,this):this._hostname},e.prototype.port=function(e){return arguments.length?(this._port=e,this):this._port},e.prototype.pathname=function(e){return arguments.length?(this._pathname=e,this):this._pathname},e.prototype.isWsWorkunits=function(){return this._pathname.toLowerCase().indexOf("wsworkunits")>=0||this._params.Wuid},e.prototype.isWorkunitResult=function(){return this.isWsWorkunits()&&(this._params.Sequence||this._params.ResultName)},e.prototype.isWsEcl=function(){return this._pathname.toLowerCase().indexOf("wsecl")>=0||this._params.QuerySetId&&this._params.Id},e.prototype.isWsWorkunits_GetStats=function(){return this._pathname.toLowerCase().indexOf("wsworkunits/wugetstats")>=0&&this._params.WUID},e.prototype.getUrl=function(e){return e=e||{},(e.protocol?e.protocol:this._protocol)+"//"+(e.hostname?e.hostname:this._hostname)+":"+(e.port?e.port:this._port)+"/"+(e.pathname?e.pathname:this._pathname)},t.prototype.contains=function(e,t){return r(e+"."+t,this._mappings)},t.prototype.mapResult=function(e,t){var n=this._mappings[t];n&&(e[t]=e[t].map(function(e){var t=[];if(n.x&&n.x instanceof Array){t=[];for(var r=0;r<n.x.length;++r)t.push(e[n.y[r]])}else for(var i in n)n[i]==="label"?t[0]=e[i]:n[i]==="weight"&&(t[1]=e[i]);return t},this))},t.prototype.mapResponse=function(e){for(var t in e)this.mapResult(e,t)},n.prototype=Object.create(e.prototype);var r=function(e,t){var n=e.split("."),r=t;for(var i=0;i<n.length;++i){var s=n[i];if(r[s]===undefined)return!1;r=r[s]}return!0},i=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")};return n.prototype.jsonp=function(t,n,r){function d(e){delete window[c],document.body.removeChild(h),r(e)}for(var s in this._proxyMappings){var o=t.split(s),u=o[0];if(o.length>1){var a=(new e).url(t);t=u+this._proxyMappings[s],n.IP=a._hostname,n.PORT=a._port,o.length>0&&(n.PATH=o[1]);break}}var f=6e4,l=5e3,c="jsonp_callback_"+Math.round(Math.random()*999999);window[c]=function(e){f=0,d(e)};var h=document.createElement("script");h.src=t+(t.indexOf("?")>=0?"&":"?")+"jsonp="+c+"&"+i(n),document.body.appendChild(h);var p=setInterval(function(){f<=0?clearInterval(p):(f-=l,f<=0?(clearInterval(p),console.log("Request timeout:  "+h.src),d()):console.log("Request pending ("+f/1e3+" sec):  "+h.src))},l)},n.prototype.mappings=function(e){return arguments.length?(this._mappings=new t(e),this):this._mappings},n.prototype.proxyMappings=function(e){return arguments.length?(this._proxyMappings=e,this):this._proxyMappings},s.prototype=Object.create(n.prototype),s.prototype.cacheCalls=function(e){return arguments.length?(this._cacheCalls=e,this):this._cacheCalls},s.prototype.call=function(e,t){function r(e,t){var r=new XMLHttpRequest;r.open("GET",n,!0),r.onload=function(e){t(JSON.parse(r.responseText))},r.onerror=function(e){t({})},r.send(null)}var n=this._url+(this._url.indexOf("?")>=0?"&":"?")+i(e);if(this._cacheCalls){var s=localStorage["hpcc.viz."+n];s&&s!==null?setTimeout(function(){t(JSON.parse(s))},0):r(e,function(e){localStorage["hpcc.viz."+n]=JSON.stringify(e),t(e)})}else localStorage["hpcc.viz."+n]=null,r(e,t)},o.prototype=Object.create(n.prototype),o.prototype.url=function(e){var t=n.prototype.url.apply(this,arguments);if(arguments.length){this._port=this._port==="8010"?"8002":this._port;for(var r in this._params)switch(r){case"QuerySetId":this.target(this._params[r]);break;case"Id":this.query(this._params[r])}var i,s;!this._target&&!this._query&&(i=this._pathname.split("/res/"),i.length>=2&&(s=i[1].split("/"),s.length>=3&&(this.target(s[1]),this.query(s[2])))),!this._target&&!this._query&&(i=this._pathname.split("/forms/default/"),i.length>=2&&(s=i[1].split("/"),s.length>=3&&(this.target(s[1]),this.query(s[2]))))}return t},o.prototype.target=function(e){return arguments.length?(this._target=e,this):this._target},o.prototype.query=function(e){return arguments.length?(this._query=e,this):this._query},o.prototype.constructUrl=function(){return n.prototype.getUrl.call(this,{pathname:"WsEcl/submit/query/"+this._target+"/"+this._query+"/json"})},o.prototype.call=function(e,t,n){e=e||{},e.target=e.target||this._target,e.query=e.query||this._query;var r=this,i=this.getUrl({pathname:"WsEcl/submit/query/"+e.target+"/"+e.query+"/json"});this.jsonp(i,t,function(e){for(var t in e){e=e[t].Results;break}for(t in e)e[t]=e[t].Row;r._mappings.mapResponse(e),n(e)})},o.prototype.send=function(e,t){this.call({target:this._target,query:this._query},e,t)},u.prototype=Object.create(n.prototype),u.prototype.url=function(e){var t=n.prototype.url.apply(this,arguments);if(arguments.length){for(var r in this._params)switch(r){case"Wuid":this.wuid(this._params[r]);break;case"ResultName":this.resultName(this._params[r]);break;case"Sequence":this.sequence(this._params[r])}if(!this._wuid){var i=this._url.split("/res/");if(i.length>=2){var s=i[1].split("/");this.wuid(s[0])}}}return t},u.prototype.wuid=function(e){return arguments.length?(this._wuid=e,this):this._wuid},u.prototype.jobname=function(e){return arguments.length?(this._jobname=e,this):this._jobname},u.prototype.sequence=function(e){return arguments.length?(this._sequence=e,this):this._sequence},u.prototype.resultName=function(e){return arguments.length?(this._resultName=e,this):this._resultName},u.prototype.appendParam=function(e,t,n){return t?(n&&(n+="&"),n+e+"="+t):n},u.prototype.constructUrl=function(){var e=n.prototype.getUrl.call(this,{pathname:"WsWorkunits/res/"+this._wuid+"/"}),t="";return t=this.appendParam("ResultName",this._resultName,t),e+(t?"?"+t:"")},u.prototype._fetchResult=function(e,t,n){e=e||{},e._start=e._start||0,e._count=e._count||-1;var r=this.getUrl({pathname:"WsWorkunits/WUResult.json"}),i={Wuid:e.wuid,ResultName:e.resultname,SuppressXmlSchema:!0,Start:e._start,Count:e._count};this._resultNameCache[e.resultname]={};var s=this;this.jsonp(r,i,function(r){for(var i in r){if(!r[i].Result)throw"No result found.";s._total=r[i].Total,r=r[i].Result;for(var o in r){r=r[o].Row;break}break}s._resultNameCache[e.resultname]=r,n||s._mappings.mapResult(s._resultNameCache,e.resultname),t(s._resultNameCache[e.resultname])})},u.prototype.fetchResult=function(e,t,n){if(e.wuid)this._fetchResult(e,t,n);else if(e.jobname){var r=this;this.WUQuery(e,function(i){e.wuid=i[0].Wuid,r._fetchResult(e,t,n)})}},u.prototype.WUQuery=function(e,t){var n=this.getUrl({pathname:"WsWorkunits/WUQuery.json"}),i={Jobname:i.jobname,Count:1};this._resultNameCache={},this._resultNameCacheCount=0,this.jsonp(n,i,function(e){if(!r("WUQueryResponse.Workunits.ECLWorkunit",e))throw"No workunit found.";e=e.WUQueryResponse.Workunits.ECLWorkunit,t(e)})},u.prototype.fetchResultNames=function(e){var t=this.getUrl({pathname:"WsWorkunits/WUInfo.json"}),n={Wuid:this._wuid,TruncateEclTo64k:!0,IncludeExceptions:!1,IncludeGraphs:!1,IncludeSourceFiles:!1,IncludeResults:!0,IncludeResultsViewNames:!1,IncludeVariables:!1,IncludeTimers:!1,IncludeResourceURLs:!1,IncludeDebugValues:!1,IncludeApplicationValues:!1,IncludeWorkflows:!1,IncludeXmlSchemas:!1,SuppressResultSchemas:!0};this._resultNameCache={},this._resultNameCacheCount=0;var i=this;this.jsonp(t,n,function(t){r("WUInfoResponse.Workunit.Results.ECLResult",t)&&(t.WUInfoResponse.Workunit.Results.ECLResult.map(function(e){i._resultNameCache[e.Name]=[],++i._resultNameCacheCount}),e(i._resultNameCache))})},u.prototype.fetchResults=function(e,t){var n=this;this.fetchResultNames(function(r){var i=n._resultNameCacheCount;if(i>0)for(var s in n._resultNameCache)n.fetchResult({wuid:n._wuid,resultname:s},function(t){--i<=0&&e(n._resultNameCache)},t);else e(n._resultNameCache)})},u.prototype.postFilter=function(e,t){var n={};for(var r in t)n[r]=t[r].filter(function(t,n){for(var r in e)if(t[r]!==undefined&&e[r]!==undefined&&t[r]!==e[r])return!1;return!0});return this._mappings.mapResponse(n),n},u.prototype.send=function(e,t){var n=this;this._resultNameCacheCount?t(n.postFilter(e,this._resultNameCache)):this.fetchResults(function(r){t(n.postFilter(e,r))},!0)},a.prototype=Object.create(n.prototype),a.prototype.url=function(e){var t=n.prototype.url.apply(this,arguments);if(arguments.length)for(var r in this._params)switch(r){case"WUID":this.wuid(this._params[r])}return t},a.prototype.wuid=function(e){return arguments.length?(this._wuid=e,this):this._wuid},a.prototype.constructUrl=function(){return n.prototype.getUrl.call(this,{pathname:"WsWorkunits/WUGetStats?WUID="+this._wuid})},a.prototype.send=function(e,t){var n=this.getUrl({pathname:"WsWorkunits/WUGetStats.json?WUID="+this._wuid});this.jsonp(n,e,function(e){r("WUGetStatsResponse.Statistics.WUStatisticItem",e)?t(e.WUGetStatsResponse.Statistics.WUStatisticItem):t([])})},f.prototype=Object.create(n.prototype),f.prototype.fetchResults=function(e,t){var n=this.getUrl({});this._resultNameCache={},this._resultNameCacheCount=0;var r=this;this.jsonp(n,e,function(e){for(var n in e){e=e[n].Results;break}for(n in e)r._resultNameCache[n]=e[n].Row,++r._resultNameCacheCount;t(r._resultNameCache)})},f.prototype.fetchResult=function(e,t){t(this._resultNameCache[e])},f.prototype.call=function(e,t){this.fetchResults(e,t)},l.prototype=Object.create(u.prototype),l.prototype.hipieResults=function(e){if(!arguments.length)return this._hipieResults;this._hipieResultsLength=0,this._hipieResults={};var t=this;return e.forEach(function(e){t._hipieResultsLength++,t._hipieResults[e.id]=e}),this},l.prototype.fetchResults=function(e){var t=this;return u.prototype.fetchResultNames.call(this,function(n){var r=t._hipieResultsLength;if(r>0)for(var i in t._hipieResults){var s=t._hipieResults[i];t.fetchResult(s.from,function(n){--r<=0&&e(t._resultNameCache)})}else e(t._resultNameCache)})},l.prototype.fetchResult=function(e,t){return u.prototype.fetchResult.call(this,{wuid:this._wuid,resultname:e},function(e){t(e)})},l.prototype.call=function(e,t){if(e.refresh||!this._resultNameCache||!this._resultNameCacheCount)this.fetchResults(t);else{var n={};for(var r in e)e[r]&&e[r+"_changed"]&&(n[r]=e[r]);var i={};for(var s in this._hipieResults){var o=this._hipieResults[s],u=!0;for(var a in n)if(o.filter.indexOf(a)<0){u=!1;break}u&&(i[o.from]=this._resultNameCache[o.from].filter(function(e){for(var t in n)if(e[t]!==n[t])return!1;return!0}))}t(i)}},c.prototype=Object.create(l.prototype),c.prototype.databomb=function(e){return arguments.length?(this._databomb=e,this):this._databomb},c.prototype.databombOutput=function(e){return arguments.length?(this._resultNameCacheCount++,this._resultNameCache[e]=this._databomb,this):undefined},c.prototype.fetchResults=function(e){var t=this;setTimeout(function(){e(t._resultNameCache)},0)},{Basic:s,ESPMappings:t,ESPUrl:e,WsECL:o,WsWorkunits:u,HIPIERoxie:f,HIPIEWorkunit:l,HIPIEDatabomb:c,createESPConnection:function(t){t=t||document.URL;var n=(new e).url(t);return n.isWsWorkunits_GetStats()?(new a).url(t):n.isWsWorkunits()?(new u).url(t):n.isWsEcl()?(new o).url(t):null}}});