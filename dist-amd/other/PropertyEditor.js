(function(e,t){typeof define=="function"&&define.amd?define(["d3","../common/HTMLWidget","../other/Persist","../layout/Grid","../common/Widget","css!./PropertyEditor"],t):e.other_PropertyEditor=t(e.d3,e.common_HTMLWidget,e.other_Persist,e.layout_Grid,e.common_Widget)})(this,function(e,t,n,r,i){function s(e){switch(e){case"widget":case"widgetArray":case"propertyArray":return!0}return!1}function o(e,n){t.call(this),this._parent=e||null,this._parentWidget=n||null,this._tag="div",this._show_settings=!1}o.prototype=Object.create(t.prototype),o.prototype.constructor=o,o.prototype._class+=" other_PropertyEditor",o.prototype.publish("showColumns",!1,"boolean","If true, widget.columns() will display as if it was a publish parameter.",null,{tags:["Basic"]}),o.prototype.publish("showData",!1,"boolean","If true, widget.data() will display as if it was a publish parameter.",null,{tags:["Basic"]}),o.prototype.publish("sorting","none","set","Specify the sorting type",["none","A-Z","Z-A","type"],{tags:["Basic"],icons:["fa-sort","fa-sort-alpha-asc","fa-sort-alpha-desc","fa-sort-amount-asc"]}),o.prototype.publish("hideNonWidgets",!1,"boolean","Hides non-widget params (at this tier only)",null,{tags:["Basic"]}),o.prototype.publish("label","","string","Label to display in header of property editor table",null,{tags:["Basic"]}),o.prototype.publish("filterTags","","set","Only show Publish Params of this type",["Basic","Intermediate","Advance",""],{}),o.prototype.publish("excludeTags",[],"array","Exclude this array of tags",null,{}),o.prototype.publish("excludeParams",[],"array","Exclude this array of params (widget.param)",null,{}),o.prototype.publish("widget",null,"widget","Widget",null,{tags:["Basic"],render:!1}),o.prototype._widgetOrig=o.prototype.widget,o.prototype.widget=function(e){if(arguments.length&&this._widgetOrig()===e)return this;var t=o.prototype._widgetOrig.apply(this,arguments);if(arguments.length){this.watchWidget(e);if(e instanceof r){var n=this;e.postSelectionChange=function(){n._selectedItems=e._selectionBag.get().map(function(e){return e.widget}),n.render()}}}return t},o.prototype.show_settings=function(e){return arguments.length?(this._show_settings=e,this):this._show_settings},o.prototype.rootWidgets=function(){return this._selectedItems&&this._selectedItems.length?this._selectedItems:this.show_settings()?[this]:this.widget()?[this.widget()]:[]},o.prototype.update=function(n,r){t.prototype.update.apply(this,arguments);var i=this,s=this.rootWidgets().filter(function(e){return e._owningWidget&&e._owningWidget.excludeObjs instanceof Array&&e._owningWidget.excludeObjs.indexOf(e.classID())!==-1?!1:!0}),o=r.selectAll(".table"+this.id()).data(s,function(e){return e.id()});o.enter().append("table").attr("class","property-table table"+this.id()).each(function(t){var n=e.select(this);n.append("thead").append("tr").append("th").datum(n).attr("colspan","2").each(function(t){var n=e.select(this);n.append("span"),i.thButtons(n)}),n.append("tbody")}),o.each(function(t){var n=e.select(this);n.select("thead > tr > th > span").text(function(e){var t="";return i.label()&&(t+=i.label()+": "),t+=e.classID(),t}),n.selectAll("i").classed("fa-eye",!i.hideNonWidgets()).classed("fa-eye-slash",i.hideNonWidgets()),i.renderInputs(n.select("tbody"),t)}),o.exit().each(function(e){i.renderInputs(r.select("tbody"),null)}).remove()},o.prototype.exit=function(e,n){t.prototype.exit.apply(this,arguments),this.watchWidget(null)};var u=0;return o.prototype.watchWidget=function(e){this._watch&&(window.__hpcc_debug&&(--u,console.log("watchDepth:  "+u)),this._watch.remove(),delete this._watch);if(e){var t=this;this._watch=e.monitor(function(e,n,r){r!==n&&t.lazyRender()}),window.__hpcc_debug&&(++u,console.log("watchDepth:  "+u))}},o.prototype.lazyRender=o.prototype.debounce(function(){this.render()},100),o.prototype.thButtons=function(e){var t=this,n=e.append("i").attr("class","fa fa-minus-square-o").on("click",function(e){e.classed("property-table-collapsed",!e.classed("property-table-collapsed")),n.classed("fa-minus-square-o",!e.classed("property-table-collapsed")).classed("fa-plus-square-o",e.classed("property-table-collapsed"))});if(this._parent===null){var r=e.append("i").attr("class","fa "+t.__meta_sorting.ext.icons[t.__meta_sorting.set.indexOf(t.sorting())]).on("click",function(){var e=t.sorting(),n=t.__meta_sorting.set,i=t.__meta_sorting.ext.icons;r.classed(i[n.indexOf(e)],!1).classed(i[(n.indexOf(e)+1)%n.length],!0),t.sorting(n[(n.indexOf(e)+1)%n.length]).render()}),i=e.append("i").attr("class","fa "+(t.hideNonWidgets()?"fa-eye-slash":"fa-eye")).on("click",function(){i.classed("fa-eye",t.hideNonWidgets()).classed("fa-eye-slash",!t.hideNonWidgets()),t.hideNonWidgets(!t.hideNonWidgets()).render()});i.classed("fa-eye",!t.hideNonWidgets()).classed("fa-eye-slash",t.hideNonWidgets())}},o.prototype.gatherDataTree=function(e){if(!e)return null;var t={label:e.id()+" ("+e.classID()+")",children:[]},r=n.discover(e);return r.forEach(function(n){var r={label:n.id,children:[]};switch(n.type){case"widget":r.children.push(this.gatherDataTree(e[n.id]()));break;case"widgetArray":case"propertyArray":var i=e[n.id]();i&&i.forEach(function(e){r.children.push(this.gatherDataTree(e))},this)}t.children.push(r)},this),t},o.prototype.getDataTree=function(){return this.gatherDataTree(this.rootWidget())},o.prototype._rowSorting=function(e){if(this.sorting()==="type"){var t=["boolean","number","string","html-color","array","object","widget","widgetArray","propertyArray"];e.sort(function(e,n){return e.type===n.type?e.id<n.id?-1:1:t.indexOf(e.type)<t.indexOf(n.type)?-1:1})}else this.sorting()==="A-Z"?e.sort(function(e,t){return e.id<t.id?-1:1}):this.sorting()==="Z-A"&&e.sort(function(e,t){return e.id>t.id?-1:1})},o.prototype.filterInputs=function(e){var t=n.discover(e);if((this.filterTags()||this.excludeTags().length>0||this.excludeParams.length>0)&&e instanceof o==0){var r=this;return t.filter(function(t,n){for(var i=0;i<r.excludeParams().length;i++){var s=r.excludeParams()[i].split("."),o,u,a;s.length>2?(o=s[0],u=s[1],a=s[2]):(o=s[0],a=s[1]);if(e.class().indexOf(o)!==-1)return t.id===a?!1:!0}return r.excludeTags().length>0&&t.ext&&t.ext.tags&&t.ext.tags.some(function(e){return r.excludeTags().indexOf(e)>-1})?!1:r.filterTags()&&t.ext&&t.ext.tags&&t.ext.tags.indexOf(r.filterTags())!==-1||!r.filterTags()?!0:!1})}return t},o.prototype.renderInputs=function(t,n){var r=this,i=[],o=!this.show_settings()&&this.showColumns();n&&(i=this.filterInputs(n).filter(function(e){return e.id!=="fields"?!0:o}),!this.show_settings()&&this.showData()&&n.data&&i.push({id:"data",type:"array"}),o&&n.columns&&i.push({id:"columns",type:"array"}),this.hideNonWidgets()&&(i=i.filter(function(e){return s(e.type)})),this._rowSorting(i));var u=t.selectAll("tr.prop"+this.id()).data(i,function(e){return e.id});u.enter().append("tr").attr("class","property-wrapper prop"+this.id()).each(function(t){var i=e.select(this);if(s(t.type))i.classed("property-widget-wrapper",!0),i.append("td").attr("colspan","2");else{i.classed("property-input-wrapper",!0),i.append("td").classed("property-label",!0).text(t.id);var o=i.append("td").classed("property-input-cell",!0);r.enterInputs(n,o,t)}}),u.each(function(t){var i=e.select(this);i.classed("disabled",n[t.id+"_disabled"]()),s(t.type)?r.updateWidgetRow(n,i.select("td"),t):r.updateInputs(n,t)}),u.exit().each(function(t){var i=e.select(this);s(t.type)&&r.updateWidgetRow(n,i.select("td"),null)}).remove(),u.order()},o.prototype.updateWidgetRow=function(t,n,r){var i=[];t&&r&&(i=t[r.id]()||[]);var s=i instanceof Array?i:[i],u=this,a=n.selectAll("div.propEditor"+this.id()).data(s,function(e){return e.id()});a.enter().append("div").attr("class","property-input-cell propEditor"+this.id()).each(function(n){e.select(this).attr("data-widgetid",n.id()).property("data-propEditor",(new o(u,t)).label(r.id).target(this))}),a.each(function(t){e.select(this).property("data-propEditor").showColumns(u.showColumns()).showData(u.showData()).sorting(u.sorting()).filterTags(u.filterTags()).excludeTags(u.excludeTags()).excludeParams(u.excludeParams()).hideNonWidgets(u.hideNonWidgets()&&t._class.indexOf("layout_")>=0).widget(t).render()}),a.exit().each(function(t){var n=e.select(this);n.property("data-propEditor").widget(null).render().target(null),n.property("data-propEditor",null)}).remove()},o.prototype.setProperty=function(e,t,n){var r=this;while(r&&e)r===this&&e[t](n),e.render?(e.render(),r=null):(r=r._parent,e=r._parentWidget)},o.prototype.enterInputs=function(t,n,r){n.classed(r.type+"-cell",!0);var i=this;switch(r.type){case"boolean":n.append("input").attr("id",this.id()+"_"+r.id).classed("property-input",!0).attr("type","checkbox").on("change",function(){i.setProperty(t,r.id,this.checked)});break;case"set":n.append("select").attr("id",this.id()+"_"+r.id).classed("property-input",!0).on("change",function(){i.setProperty(t,r.id,this.value)}).each(function(t){var n=e.select(this);for(var i=0;i<r.set.length;i++)n.append("option").attr("value",r.set[i]).text(r.set[i])});break;case"array":case"object":n.append("textarea").attr("id",this.id()+"_"+r.id).classed("property-input",!0).on("change",function(){i.setProperty(t,r.id,JSON.parse(this.value))});break;default:n.append("input").attr("id",this.id()+"_"+r.id).classed("property-input",!0).on("change",function(){i.setProperty(t,r.id,this.value)}),r.type==="html-color"&&!this.isIE&&n.append("input").attr("id",this.id()+"_"+r.id+"_2").classed("property-input",!0).attr("type","color").on("change",function(){i.setProperty(t,r.id,this.value)})}},o.prototype.updateInputs=function(t,r){var s=e.selectAll("#"+this.id()+"_"+r.id+", #"+this.id()+"_"+r.id+"_2"),o=t?t[r.id]():"";s.property("disabled",t[r.id+"_disabled"]());switch(r.type){case"array":case"object":s.property("value",JSON.stringify(o,function(t,r){return r instanceof i?n.serialize(r):r}));break;case"boolean":s.property("checked",o);break;default:s.property("value",o)}},o});