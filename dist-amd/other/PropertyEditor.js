(function(e,t){typeof define=="function"&&define.amd?define(["d3","../common/Widget","../common/HTMLWidget","./Persist","../layout/Grid","../layout/Accordion","../form/Form","../form/Input","css!./PropertyEditor"],t):e.other_PropertyEditor=t(e.d3,e.common_Widget,e.common_HTMLWidget,e.other_Persist,e.layout_Grid,e.layout_Accordion,e.form_Form,e.form_Input)})(this,function(e,t,n,r,i,s,o,u){function a(){s.call(this),this._tag="div",this._columns=["Key","Value"],this._contentEditors=[],this._show_settings=!0,this._dataDiv={},this._previousIds="",this.__propertyEditor_watch=[]}return a.prototype=Object.create(s.prototype),a.prototype.constructor=a,a.prototype._class+=" other_PropertyEditor",a.prototype.publish("showColumns",!1,"boolean","Show Columns",null,{tags:["Intermediate"]}),a.prototype.publish("showData",!1,"boolean","Show Data",null,{tags:["Intermediate"]}),a.prototype.publish("paramsBeforeWidgets",!0,"boolean","The non-widget parameter collapsible is placed before widget section(s)",null,{tags:["Private"]}),a.prototype.publish("paramGrouping","By Widget","set","Param Grouping",["By Param","By Widget"],{tags:["Basic"]}),a.prototype.publish("excludeTags",[],"array","Array of publish parameter tags to exclude from PropertEditor",null,{tags:["Private"]}),a.prototype.publish("showProperties",[],"array","Array of publish parameter IDs to include in PropertEditor (all others will be excluded)",null,{tags:["Private"]}),a.prototype.publish("settingsWidget",null,"widget","Another instance of PropertyEditor containing the publish parameters for the main instance of PropertyEditor",null,{tags:["Private"]}),a.prototype.publish("ignoredClasses",[],"array","Array of class chain substrings to hide params on match",null,{tags:["Basic"]}),a.prototype.data=function(e){var t=n.prototype.data.apply(this,arguments);if(arguments.length){var r=this;e[0]instanceof i&&(e[0].postSelectionChange=function(){var t=e[0]._selectionBag.get().map(function(e){return e.widget});r.data(t.length>0?t:[e[0]]).paramGrouping(t.length>1?"By Param":"By Widget").render()})}return t},a.prototype.show_settings=function(e){return arguments.length?(this._show_settings=e,this):this._show_settings},a.prototype.excludeWidgets=function(e){return arguments.length?(this._excludeWidgets=e,this):this._excludeWidgets},a.prototype.onChange=function(e,t){},a.prototype.paramFilter=function(){var e=this.showProperties(),t=this.excludeTags();return function(n,r){var i=e;if(i.length>0&&i.indexOf(r.id)===-1)return!0;if(t.length>0&&typeof r.ext=="object"&&typeof r.ext.tags=="object")for(var s in r.ext.tags)if(t.indexOf(r.ext.tags[s])!==-1)return!0;return!1}},a.prototype.enter=function(e,t){s.prototype.enter.apply(this,arguments),this._parentElement.filter(".other_PropertyEditor div").empty()&&this._parentElement.style("overflow","auto"),this.title()===""&&this.title("Property Editor"),this.show_settings()&&this.pushListItem((new a).showColumns(!1).showData(!1).show_settings(!1).excludeWidgets(!0).defaultCollapsed(!0).excludeTags(["Private"]).paramGrouping("By Widget").title("Editor Settings").data([this]),null,!0)},a.prototype.update=function(e,t){var n=this;switch(this.paramGrouping()){case"By Param":var i=this.getAllParams();this.clearListItems(),this.removeWatches();for(var u in this.data())this.createWatch(this.data()[u]);var f=this.categorizeParams(i);for(var l in f){var c=[];for(var h in f[l]){var p=f[l][h];c.push(this.getSharedParamInputObj(p))}this.pushListItem((new s).title(l+":").pushListItem((new o).showSubmit(!1).inputs(c)))}break;case"By Widget":this.clearListItems(),this.removeWatches();for(var d=0;d<this.data().length;d++){this.createWatch(this.data()[d]);var v=[],m=this.data()[d]._class.split("_").pop();r.propertyWalker(this.data()[d],n.paramFilter(),function(e,t){switch(t.type){case"widget":if(!n.excludeWidgets()){var r=e[t.id]()._class.split("_").pop();n.pushListItem((new a).showData(n.showData()).showColumns(n.showColumns()).show_settings(!1).title(r).data([e[t.id]()]).ignoredClasses(n.ignoredClasses()))}break;case"widgetArray":if(!n.excludeWidgets()){var i=e[t.id](),s=[];for(var o=0;o<i.length;o++)s.push(i[o]._class.split("_").pop());n.pushListItem((new a).show_settings(!1).title(m+"."+t.id+": ["+s.join(", ")+"]").data(i).ignoredClasses(n.ignoredClasses()))}break;default:v.push(n.getParamInputObj(e,t))}}),this.showData()&&v.push(this.getDataInputObj(this.data()[d])),this.showColumns()&&v.push(this.getColumnsInputObj(this.data()[d]));if(v.length>0&&this.classIsNotHidden(this.data()[d]._class)){var g;this.excludeWidgets()?(this.clearListItems(),g=(new o).showSubmit(!1).inputs(v)):this.content().length>0?g=(new s).title(m+" Params:").pushListItem((new o).showSubmit(!1).inputs(v)):g=(new o).showSubmit(!1).inputs(v),this.pushListItem(g,this.paramsBeforeWidgets())}}}s.prototype.update.apply(this,arguments)},a.prototype.exit=function(e,t){this.removeWatches(),n.prototype.exit.apply(this,arguments)},a.prototype.removeWatches=function(){this.__propertyEditor_watch.forEach(function(e){e.remove()}),this.__propertyEditor_watch=[]},a.prototype.createWatch=function(e){var t=this;this.__propertyEditor_watch.push(e.monitor(function(e,n){typeof n=="object"&&t.render()}))},a.prototype.categorizeParams=function(e){var t={Colors:["palette","color"],Font:["font"],Axis:["axis"],General:[]},n={};for(var r in e){for(var i in t)if(r.toLowerCase().indexOf(t[i])!==-1)break;typeof n[i]=="undefined"&&(n[i]=[]),n[i].push(e[r])}return n},a.prototype.classIsNotHidden=function(e){var t=this.ignoredClasses();for(var n in t)if(e.indexOf(t[n])!==-1)return!1;return!0},a.prototype.getAllParams=function(){var e=this,t={};for(var n in this.data())r.widgetPropertyWalker(this.data()[n],e.paramFilter(),function(e,n){switch(n.type){case"widget":case"widgetArray":break;default:typeof t[n.id]=="undefined"&&(t[n.id]=[]),t[n.id].push({widget:e,param:n})}});return t},a.prototype.getParamInputObj=function(e,t){var n=["widget","widgetArray"].indexOf(t.type)===-1?e[t.id]():null,r=(new u).name(e._id+"-"+t.id).label(t.id).type(this.inputTypeMapping(t.type)).value(n);return t.type==="set"&&r.selectOptions(t.set).value(n),r.change=function(n){if(t.type==="boolean")e[t.id](n._element.select("input").property("checked")).render();else if(t.type==="array"){var r=n.value().split(",").filter(function(e){return e.length});e[t.id](r).render()}else e[t.id](n.value()).render()},r._paramId=t.id,r},a.prototype.getSharedParamInputObj=function(e){var t=e[0].param.id,n=e[0].param.type,r=(new u).name(t).label(t).type(this.inputTypeMapping(n));return n==="set"&&r.selectOptions(e[0].param.set),r.change=function(r){for(var i in e)if(n==="boolean")e[i].widget[t](r._element.select("input").property("checked")).render();else if(n==="array"){var s=r.value().split(",").filter(function(e){return e.length});e[i].widget[t](s).render()}else e[i].widget[t](r.value()).render()},r._paramId=t,r},a.prototype.getDataInputObj=function(e){var t="";try{t=JSON.stringify(e.data())}catch(n){}var r=(new u).name(e._id+"-data").label("Data").type("textarea").value(t);return r.change=function(t){try{e.data(JSON.parse(t.value())).render()}catch(n){}},r},a.prototype.getColumnsInputObj=function(e){var t=(new u).name(e._id+"-columns").label("Columns").type("textarea").value(e.columns());return t.change=function(t){e.columns(t.value().split(",")).render()},t},a.prototype.inputTypeMapping=function(e){switch(e){case"set":return"select";case"array":return"textarea";case"boolean":return"checkbox";case"string":return"text";default:return e}},a.prototype.click=function(e){},a});