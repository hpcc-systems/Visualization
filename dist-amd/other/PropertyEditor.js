(function(e,t){typeof define=="function"&&define.amd?define(["d3","../common/Widget","../common/HTMLWidget","./Persist","css!./PropertyEditor"],t):e.other_PropertyEditor=t(e.d3,e.common_Widget,e.common_HTMLWidget,e.other_Persist)})(this,function(e,t,n,r){function i(){n.call(this),this._tag="div",this._columns=["Key","Value"],this._contentEditors=[],this._show_settings=!0}i.prototype=Object.create(n.prototype),i.prototype._class+=" other_PropertyEditor",i.prototype.publish("themeMode",!1,"boolean","Edit default values",null,{tags:["Basic","TODO2"]}),i.prototype.publish("showColumns",!0,"boolean","Show Columns",null,{tags:["Intermediate","TODO2"]}),i.prototype.publish("showData",!0,"boolean","Show Data",null,{tags:["Intermediate","TODO2"]}),i.prototype.publish("shareCountMin",2,"number","Share Count Min",null,{tags:["Basic","TODO2"]}),i.prototype.publish("paramGrouping","By Widget","set","Param Grouping",["By Param","By Widget"],{tags:["Basic","TODO2"]}),i.prototype.publish("sectionTitle","","string","Section Title",null,{tags:["Private","TODO2"]}),i.prototype.publish("collapsibleSections",!0,"boolean","Collapsible Sections",null,{tags:["Basic","TODO2"]}),i.prototype.show_settings=function(e){return arguments.length?(this._show_settings=e,this):this._show_settings};var s=function(e,t,n,r,i){if(!e)return"";var s=e.classID().split("_"),o="src/"+s.join("/"),u=s[s.length-1],a=n.split("\n").map(function(e){return e.length?"        "+e:""}).join("\n");return a+=a.length?"\n":"",i+=i.length?"\n":"",'require(["'+o+'"], function('+u+") {\n"+"    var "+t+" = new "+u+"()\n"+'        .target("divID")\n'+a+"        .render("+r.split("\n").join("\n        ")+")\n"+"    ;\n"+i+"});"},o=function(e,t,n){var r=t.split("\n").map(function(e){return e.length?"        "+e:""}).join("\n");return r+=r.length?"\n":"","function(widget) {\n    widget."+e+"\n"+r+"        .render("+n+")\n"+"    ;\n"+"}"},u=function(e,t,n){if(!e)return"";var i=this,s=r.discover(this.theme_mode()?Object.getPrototypeOf(e):e).map(function(t){return i.widgetPropertyModified(e,t.id)?"."+t.id+"("+JSON.stringify(i.widgetProperty(e,t.id))+")":""}).filter(function(e){return e!==""}).join("\n");if(t){var o=e.columns();o instanceof Array?o.length&&(s+=s.length?"\n":"",s+=".columns("+JSON.stringify(o)+")"):o&&(s+=s.length?"\n":"",s+=".columns("+JSON.stringify(o)+")")}if(n){var u=e.data();if(u instanceof Array)u.length&&(s+=s.length?"\n":"",s+=".data("+JSON.stringify(u)+")");else if(u){s+=s.length?"\n":"";try{s+=".data("+JSON.stringify(u)+")"}catch(a){s+=".data("+a+")"}}}return s};i.prototype.getJavaScript=function(e,t,n,r){r=r||"";var i="";return this._data._content&&(i=o("_content",u(this._data._content,t,n),"")),s(this._data,e,u(this._data,t,n),i,r)},i.prototype.getPersistString=function(e){return"var "+e+" = "+JSON.stringify(r.serializeToObject(this._data,null,!1),null,"  ")+";"},i.prototype.onChange=function(e,t){},i.prototype.enter=function(e,t){n.prototype.enter.apply(this,arguments),this._parentElement.style("overflow","auto")},i.prototype.findSharedProperties=function(e,t){var n={};if(typeof e!="undefined"&&e.length>0){var r=[];e.forEach(function(e){var n=this._getParams(t?Object.getPrototypeOf(e):e,0);r=r.concat(n)},this),r.forEach(function(e){if(["widget","widgetArray"].indexOf(e.type)===-1){var t=e.id+"_"+e.description;typeof n[t]=="undefined"&&(n[t]={arr:[]}),n[t].id=e.id,n[t].description=e.description,n[t].type=e.type,n[t].set=e.set,n[t].arr.push(e)}})}return n},i.prototype._getParams=function(e,t){var n=[],i=r.discover(e);return i.forEach(function(r,i){n.push({id:r.id,type:r.type,description:r.description,set:r.set,widget:e});if(r.type==="widgetArray"){var s=this.widgetProperty(e,r.id);s.forEach(function(e){var r=this._getParams(e,t+1);n=n.concat(r)},this)}else if(r.type==="widget"){var o=this.widgetProperty(e,r.id),u=this._getParams(o,t+1);n=n.concat(u)}},this),n};var a=function(e){var t=!1;return typeof e._current_grouping=="undefined"?e._current_grouping=e._group_params_by:e._current_grouping!==e._group_params_by&&(t=!0),typeof e._showing_columns=="undefined"?e._showing_columns=e.showColumns():e._showing_columns!==e.showColumns()&&(t=!0),typeof e._showing_data=="undefined"?e._showing_data=e.showData():e._showing_data!==e.showData()&&(t=!0),typeof e._showing_themeMode=="undefined"?e._showing_themeMode=e.themeMode():e._showing_themeMode!==e.themeMode()&&(t=!0),t};return i.prototype.widgetPropertyModified=function(e,t){return!this.themeMode()||this===e?e[t+"_modified"]():Object.getPrototypeOf(e)[t+"_modified"]()},i.prototype.widgetProperty=function(e,t,n){return n===undefined?!this.themeMode()||this===e?e[t]():Object.getPrototypeOf(e)[t]():!this.themeMode()||this===e?e[t](n):Object.getPrototypeOf(e)[t](n)},i.prototype.update=function(t,s){n.prototype.update.apply(this,arguments);var o=this;a(this)&&s.selectAll("#"+this._id+" > table").remove(),this._current_grouping=this.paramGrouping();if(this._show_settings){var u=s.selectAll("#"+this._id+" > div").data([this],function(e){return e._id});u.enter().append("div").each(function(t){(new i).showColumns(!1).showData(!1).show_settings(!1).paramGrouping("By Widget").sectionTitle("Property Editor Settings").target(e.select(this).node()).data([t]).render()})}if(this.paramGrouping()==="By Param"){var f=[],l=[];if(this._data.length>0){f.push(this.findSharedProperties(this._data,this.themeMode()));for(var c in f){var h=[];for(var p in f[c]){var d=[];f[c][p].arr.forEach(function(e){d.push(e.widget)});if(this.shareCountMin()<=d.length||d[0]._class.indexOf("PropertyEditor")!==-1)h.push({rowType:"shared",widgetArr:d,id:f[c][p].id,description:f[c][p].description,type:f[c][p].type,set:f[c][p].set}),f[c][p].arr.forEach(function(e){h.push({rowType:"individual",widgetArr:[e.widget],id:f[c][p].id,description:f[c][p].description,type:f[c][p].type,set:f[c][p].set})})}l.push(h)}}}var v=null;v=s.selectAll("#"+this._id+" > table").data(this._data,function(e){return e._id}),v.enter().append("table").each(function(t){var n=e.select(this),r=n.append("thead");o.collapsibleSections()&&r.attr("class","mm-label max").on("click",function(){var t=e.select(this);t.classed("min")?(t.classed("max",!0),t.classed("min",!1)):(t.classed("max",!1),t.classed("min",!0))}),r.append("tr").append("th").attr("colspan",o._columns.length).attr("class","th-widget-class").text(function(){var e="";if(o.sectionTitle())e=o.sectionTitle();else{var n=t.classID().split("_");n.length>1?e="Widget: "+n[n.length-1]:e="Widget: "+t._class}return e}),r=r.append("tr").attr("class","mm-content"),n.append("tbody").attr("class","mm-content");var i=r.selectAll("th").data(o._columns,function(e){return e});i.enter().append("th").text(function(e){return e}),i.exit().remove()}),v.select("tbody").each(function(t,n){var s=e.select(this),u,a,f,c=null;o.showColumns()&&(a=s.append("tr"),f=a.append("td").text("Columns"),f=a.append("td"),c=f.append("textarea").attr("rows","4").attr("cols","25").on("change",function(){t.columns(JSON.parse(this.value)).render(function(){o.onChange(t,"columns")})}),c.node().value=JSON.stringify(t._columns));if(o.showData()){a=s.append("tr"),f=a.append("td").text("Data"),f=a.append("td"),c=f.append("textarea").attr("rows","4").attr("cols","25").on("change",function(){t.data(JSON.parse(this.value)).render(function(){o.onChange("data")})});try{c.node().value=JSON.stringify(t._data)}catch(h){c.node().value=h}}o.paramGrouping()==="By Param"?(u=s.selectAll(".tr_"+t._id).data(l[n]),u.enter().append("tr").each(function(n){var r=e.select(this),i="propertyRow";n.rowType==="shared"?i="sharedPropertyRow":n.rowType==="individual"&&(this.hidden=!0),r.attr("class","tr_"+t._id+" "+i),r.append("td").attr("class","pe-label").html(function(e){var t="";switch(e.rowType){case"shared":t=e.id;break;case"individual":var n=e.widgetArr[0].classID().split("_"),r=n[n.length-1];t=r+" ["+e.widgetArr[0]._id+"]"}return t}).on("click",function(e){var t,n=this.className.split(" ");if(n.indexOf("expanded")===-1)t=!1,n.push("expanded"),this.className=n.join(" ");else{t=!0;var r="";n.forEach(function(e){e!=="expanded"&&(r+=e)}),this.className=r}var i=e.widgetArr.length,s=this.parentNode.nextSibling;for(var o=0;o<i;o++)s.hidden=t,s=s.nextSibling}),r.append("td").attr("class","field").each(function(){var r=e.select(this),i=null;switch(n.type){case"boolean":i=r.append("input").attr("class","input_"+t._id).attr("type","checkbox").on("change",function(){var e=this;n.widgetArr.forEach(function(t){o.widgetProperty(t,n.id,e.checked).render(function(e){o.onChange(e,n.id),o.render()})})});break;case"number":typeof n.ext!="undefined"&&typeof n.ext.inputType!="undefined"&&(n.ext.inputType==="textarea"?i=r.append("textarea"):n.ext.inputType==="range"&&(i=r.append("input").attr("type","range").attr("min",n.ext.min).attr("max",n.ext.max).attr("step",n.ext.step)));if(typeof i=="undefined"||i===null)i=r.append("input");i.attr("class","input_"+t._id).on("change",function(){var e=this;n.widgetArr.forEach(function(t){o.widgetProperty(t,n.id,e.value)}),t.render()});break;case"string":typeof n.ext!="undefined"&&typeof n.ext.inputType!="undefined"&&n.ext.inputType==="textarea"&&(i=r.append("textarea"));if(typeof i=="undefined"||i===null)i=r.append("input");i.attr("class","input_"+t._id).on("change",function(){var e=this;n.widgetArr.forEach(function(t){o.widgetProperty(t,n.id,e.value)}),t.render()});break;case"html-color":i=r.append("input").attr("class","input_"+t._id).on("change",function(){var e=this;n.widgetArr.forEach(function(t){o.widgetProperty(t,n.id,e.value).render(function(e){o.onChange(e,n.id),o.render()})})});if(!o.isIE)try{var s=i,u=r.append("input").attr("type","color").on("change",function(){var e=s.node();e.value=this.value,s.on("change").apply(s.node())});n.widgetArr.forEach(function(e){u.node().value=o.widgetProperty(e,n.id)})}catch(a){u.remove()}break;case"set":i=r.append("select").attr("class","input_"+t._id).on("change",function(){var e=this;n.widgetArr.forEach(function(t){o.widgetProperty(t,n.id,e.value).render(function(e){o.onChange(e,n.id),o.render()})})}),n.set.forEach(function(e){i.append("option").attr("value",e).text(e)});break;case"array":i=r.append("textarea").attr("class","input_"+t._id).attr("rows","4").attr("cols","25").on("change",function(){var e=this;n.widgetArr.forEach(function(t){o.widgetProperty(t,n.id,JSON.parse(e.value)).render(function(e){o.onChange(e,n.id),o.render()})})});break;default:}})}),u.selectAll("td.pe-label").each(function(e){var t="";switch(e.rowType){case"shared":t=e.id;break;case"individual":var n=e.widgetArr[0].classID().split("_")[1];t=n+" ["+e.widgetArr[0]._id+"]"}this.innerHTML=t}),u.select(".input_"+t._id).each(function(t){var n=e.select(this);t.rowType==="individual"&&t.widgetArr.forEach(function(e){switch(t.type){case"boolean":n.node().checked=o.widgetProperty(e,t.id);break;case"html-color":n.node().value=o.widgetProperty(e,t.id);break;case"array":n.node().value=JSON.stringify(o.widgetProperty(e,t.id),null,"  ");break;case"widget":var r=o.widgetProperty(e,t.id);e["_propertyEditor_"+t.id].data(r?[r]:[]).render();break;case"widgetArray":e["_propertyEditor_"+t.id].data(o.widgetProperty(t.widget,t.id)).render();break;case"number":case"string":case"set":default:n.node().value=o.widgetProperty(e,t.id)}})}),u.exit().each(function(t){var n=e.select(this);console.log("PropertyEditor exit:"+t._class+t._id);switch(t.type){case"widget":t.propertyEditor.target(null);break;case"widgetArray":n.html("")}}).remove()):o.paramGrouping()==="By Widget"&&(u=s.selectAll(".tr_"+t._id).data(r.discover(o.themeMode()?Object.getPrototypeOf(t):t),function(e){return t._id+"_"+e.id+"_"+e.type}),u.enter().append("tr").each(function(n){var r=e.select(this);r.attr("class","tr_"+t._id),r.append("td").attr("class","pe-label").text(function(e){return e.id});var s="input";typeof n.ext!="undefined"&&typeof n.ext.inputType!="undefined"&&n.ext.inputType==="textarea"&&(s="textarea"),r.append("td").attr("class","field").each(function(){var r=e.select(this),u=null;switch(n.type){case"boolean":u=r.append(s).attr("class","input_"+t._id).attr("type","checkbox").on("change",function(){o.widgetProperty(t,n.id,this.checked).render(function(){o.onChange(t,n.id),o.render()})});break;case"number":case"string":typeof n.ext!="undefined"&&typeof n.ext.inputType!="undefined"&&(n.ext.inputType==="textarea"?u=r.append("textarea"):n.type==="number"&&n.ext.inputType==="range"&&(u=r.append("input").attr("type","range").attr("min",n.ext.min).attr("max",n.ext.max).attr("step",n.ext.step))),u===null&&(u=r.append("input")),u.attr("class","input_"+t._id).on("change",function(){o.widgetProperty(t,n.id,this.value).render(function(e){o.onChange(e,n.id),o.render()})});break;case"html-color":u=r.append("input").attr("class","input_"+t._id).on("change",function(){o.widgetProperty(t,n.id,this.value).render(function(e){o.onChange(e,n.id),o.render()})});if(!o.isIE)try{var a=u,f=r.append("input").attr("type","color").on("change",function(){var e=a.node();e.value=this.value,a.on("change").apply(a.node())});f.node().value=o.widgetProperty(t,n.id)}catch(l){f.remove()}break;case"set":u=r.append("select").attr("class","input_"+t._id).on("change",function(){o.widgetProperty(t,n.id,this.value).render(function(e){o.onChange(e,n.id),o.render()})}),n.set.forEach(function(e){u.append("option").attr("value",e).text(e)});break;case"array":u=r.append("textarea").attr("class","input_"+t._id).attr("rows","4").attr("cols","25").on("change",function(){o.widgetProperty(t,n.id,JSON.parse(this.value)).render(function(){o.onChange(t,n.id),o.render()})});break;case"widget":case"widgetArray":u=r.append("div").attr("class","input_"+t._id),t["_propertyEditor_"+n.id]=(new i).paramGrouping("By Widget").showColumns(o.showColumns()).showData(o.showData()).show_settings(!1).target(u.node()),t["_propertyEditor_"+n.id].onChange=function(e,t){o.onChange(e,t)};break;default:}})}),u.select(".input_"+t._id).each(function(n){var r=e.select(this);switch(n.type){case"boolean":r.node().checked=o.widgetProperty(t,n.id);break;case"html-color":r.node().value=o.widgetProperty(t,n.id);break;case"array":r.node().value=JSON.stringify(o.widgetProperty(t,n.id),null,"  ");break;case"widget":var i=o.widgetProperty(t,n.id);t["_propertyEditor_"+n.id].data(i?[i]:[]).render();break;case"widgetArray":t["_propertyEditor_"+n.id].data(o.widgetProperty(t,n.id)).render();break;case"number":case"string":case"set":default:r.node().value=o.widgetProperty(t,n.id)}}),u.exit().each(function(t){var n=e.select(this);console.log("PropertyEditor exit:"+t._class+t._id);switch(t.type){case"widget":t.propertyEditor.target(null);break;case"widgetArray":n.html("")}}).remove())}),v.exit().remove()},i.prototype.exit=function(e,t){n.prototype.exit.apply(this,arguments)},i.prototype.click=function(e){},i});