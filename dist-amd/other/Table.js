(function(e,t){typeof define=="function"&&define.amd?define(["d3","../common/HTMLWidget","./Paginator","../common/Utility","css!./Table"],t):e.other_Table=t(e.d3,e.common_HTMLWidget,e.other_Paginator,e.common_Utility)})(this,function(e,t,n,r){function i(){t.call(this),this._tag="div",this._currentSort="",this._currentSortOrder=1,this.columns([]),this._paginator=new n,this._selectionBag=new r.Selection,this._selectionPrevClick=null,this._paginatorTableSpacing=4}return i.prototype=Object.create(t.prototype),i.prototype.constructor=i,i.prototype._class+=" other_Table",i.prototype.publish("renderHtmlDataCells",!1,"boolean","enable or disable HTML within cells",null,{tags:["Private"]}),i.prototype.publish("pagination",!1,"boolean","Enable or disable pagination",null,{tags:["Private"]}),i.prototype.publishProxy("itemsPerPage","_paginator"),i.prototype.publishProxy("pageNumber","_paginator","pageNumber",1),i.prototype.publishProxy("adjacentPages","_paginator"),i.prototype.publish("showHeader",!0,"boolean","Show or hide the table header",null,{tags:["Private"]}),i.prototype.publish("fixedHeader",!1,"boolean","Enable or disable fixed table header",null,{tags:["Private"]}),i.prototype.publish("fixedColumn",!1,"boolean","Enable or disable fixed first column",null,{tags:["Private"]}),i.prototype.publish("fixedSize",!1,"boolean","Fix Size to Min Width/Height"),i.prototype.publish("theadFontSize",null,"string","Table head font size",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tbodyFontSize",null,"string","Table body font size",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tfootFontSize",null,"string","Table body font size",null,{tags:["Basic"],optional:!0}),i.prototype.publish("theadFontColor",null,"html-color","Table head font color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tbodyFontColor",null,"html-color","Table body font color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tfootFontColor",null,"html-color","Table body font color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("theadFontFamily",null,"string","Table head font family",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tbodyFontFamily",null,"string","Table body font family",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tfootFontFamily",null,"string","Table body font family",null,{tags:["Basic"],optional:!0}),i.prototype.publish("theadCellBorderColor",null,"html-color","Table head cell border color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tfootCellBorderColor",null,"html-color","Table head cell border color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("theadRowBackgroundColor",null,"html-color","Table head row color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tfootRowBackgroundColor",null,"html-color","Table head row color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tbodyCellBorderColor",null,"html-color","Table body cell border color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tbodyRowBackgroundColor",null,"html-color","Table body row color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tbodyFixedColFontColor",null,"html-color","Table body first column font color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tbodyFixedColBackgroundColor",null,"html-color","Table body first column background color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tbodyHoverRowFontColor",null,"html-color","Table body hover row font color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tbodyHoverRowBackgroundColor",null,"html-color","Table body hover row background color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tbodySelectedRowFontColor",null,"html-color","Table body selected row color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tbodySelectedRowBackgroundColor",null,"html-color","Table body selected row color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tableZebraColor",null,"html-color","Table zebra row color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("totalledColumns",[],"array","Array of indices of the columns to be totalled",null,{tags:["Basic"],optional:!0}),i.prototype.publish("totalledLabel",null,"string","Adds a label to the first column of the 'Totalled' row",null,{tags:["Basic"],optional:!0}),i.prototype.publish("columnPatterns",[],"array","Array of formatting rules for each column",null,{tags:["Basic"],optional:!0}),i.prototype.publish("stringAlign","left","set","Array of alignment positions for strings",["left","right","center"],{tags:["Basic"],optional:!0}),i.prototype.publish("numberAlign","right","set","Array of alignment positions for numbers",["left","right","center"],{tags:["Basic"],optional:!0}),i.prototype.data=function(e){var n=t.prototype.data.apply(this,arguments);return arguments.length&&(this._currentSort="",this._currentSortOrder=1),n},i.prototype.size=function(e){var n=t.prototype.size.apply(this,arguments);return arguments.length&&this.tableDiv&&(this.tableDiv.style("width",this._size.width+"px").style("height",this._size.height+"px"),this.headerDiv.style("width",this._size.width+"px").style("height",this._size.height+"px")),n},i.prototype.enter=function(e,n){t.prototype.enter.apply(this,arguments),this._parentElement.style("overflow","hidden"),this.tableDiv=n.append("div").attr("class","tableDiv"),this.table=this.tableDiv.append("table"),this.thead=this.table.append("thead").append("tr"),this.tbody=this.table.append("tbody"),this.tfoot=this.table.append("tfoot").append("tr"),this.headerDiv=n,this.tableDiv.style("overflow","auto").style("width",this.width()+"px").style("height",this.height()+"px"),this.headerDiv.style("width",this.width()+"px").style("height",this.height()+"px")},i.prototype._generateTempRow=function(){var e=this.tbody.append("tr");return e.append("td").text("QQQ"),e},i.prototype._createSelectionObject=function(e){var t=this;return{_id:e,element:function(){return t.tbody.selectAll("tr").filter(function(t){return t===e})}}},i.prototype._calcRowsPerPage=function(e){this._paginator.numItems()===0&&(this._paginator.numItems(1),this.itemsPerPage(1)),this._paginator.render();var t=this.thead.selectAll("th").node().clientHeight,n=this.tfoot.node().clientHeight,r=this._generateTempRow(),i=r.node().clientHeight;r.remove();var s=this.calcHeight(this._paginator.element()),o=Math.floor((this.height()-t-n-s-(this.hasHScroll(this.tableDiv)?this.getScrollbarWidth():0)-this._paginatorTableSpacing*2)/i)||1;return o},i.prototype.update=function(n,r){t.prototype.update.apply(this,arguments);var i=this;this.showHeader()||this.fixedHeader(!1);var s=this.thead.selectAll("th").data(this.showHeader()?this.columns():[],function(e){return e});s.enter().append("th").each(function(t){var n=e.select(this);n.append("span").classed("thText",!0),n.append("span").classed("thIcon",!0)}).on("click",function(e,t){i.headerClick(e,t)}),s.style({color:this.theadFontColor(),"font-size":this.theadFontSize(),"border-color":this.theadCellBorderColor(),"background-color":this.theadRowBackgroundColor()}),s.select(".thText").style("font-family",this.theadFontFamily()).text(function(e){return e}),s.select(".thIcon").text(function(e,t){return i._currentSortOrder===-1?i._currentSort===t?"":"":i._currentSort===t?"":""}),s.exit().remove(),s.order();if(this.pagination()){this._paginator.target()===null&&this._paginator.target(r.node());var o=this._calcRowsPerPage(s);this.itemsPerPage(o),this._paginator.numItems(this.data().length),this._tNumPages=Math.ceil(this._paginator.numItems()/this.itemsPerPage())||1,(this.pageNumber()>this._tNumPages||this.pageNumber()<=0)&&this.pageNumber(1),this._paginator._onSelect=function(e,t){i.pageNumber(e),i.render();return},this.tableDiv.style("overflow-y","hidden")}else this.tableDiv.style("overflow-y",null),this._paginator.numItems(0);var u=this.pageNumber()-1,a=this.itemsPerPage(),f=u*a,l=parseInt(u*a)+parseInt(a),c=null;this.pagination()?c=this.data().slice(f,l):c=this.data();var h=[this.totalledLabel()?this.totalledLabel():null];if(i.totalledColumns().length!==0){var p=i.totalledColumns();for(var d=1;d<i.columns().length;d++){var v=0;if(p.indexOf(d)!==-1){for(var m=0;m<c.length;m++)v+=c[m][d];h.push(v)}else h.push("")}this.tfoot.selectAll("td").remove();var g=this.tfoot.selectAll("td").data(h).enter().append("td").text(function(e){return e});g.style("background-color",this.tfootRowBackgroundColor()).style("border-color",this.tfootCellBorderColor()).style("color",this.tfootFontColor()).style("font-size",this.tfootFontSize())}var y=this.tbody.selectAll("tr").data(c);this.setRowEvents(y),y.attr("class",function(e){if(i._selectionBag.isSelected(i._createSelectionObject(e)))return"selected"}),y.exit().remove(),y.each(function(){var t=e.select(this);i.applyStyleToRows(t)});var b=y.selectAll("td").data(function(e){return e.filter(function(e,t){return t<i.columns().length})});b.enter().append("td"),b[this.renderHtmlDataCells()?"html":"text"](function(e,t){var n=i.columnPatterns()[t]?i.getColumnFormatting(e,t):e;return n}),b.exit().remove(),y.each(function(t,n){e.select(this).selectAll("td").each(function(t,r){var s=i.getColumnAlignment(t);e.select(this).classed("tr-"+n+"-td-"+r,!0).style("text-align",s)})}),this._paginator.render(),this.data().length&&this.fixedLabelsUpdate(n,r),i.applyStyleToRows(this.tbody.selectAll("tr")),this._paginator.right((this.hasVScroll(this.tableDiv)?this.getScrollbarWidth():0)+this._paginatorTableSpacing).bottom((this.hasHScroll(this.tableDiv)?this.getScrollbarWidth():0)+this._paginatorTableSpacing).render()},i.prototype.fixedLabelsUpdate=function(t,n){function p(){function A(){m=L.width-parseInt(d),y=r.table.node().offsetWidth-d+r.getScrollbarWidth(),g=m>y?y:m,g+="px"}function O(){v=L.height-parseInt(c)+r.getScrollbarWidth(),v+="px"}var h=n.selectAll("th");h.style("border-color",r.theadCellBorderColor());if(r.fixedHeader()){s.select(".labels-wrapper > thead").html(f.html()),o.style("width",r.table.style("width")).style("position","absolute");var p=r._parentElement.selectAll(".cols-wrapper th");h.each(function(t,n){var r=p.filter(function(e,t){return t===n}),i=e.select(this).style("width");r.style("width",i)}),p.on("click",function(e,t){r.headerClick(e,t)}),a.html("")}var d,v,m,g,y;if(r.fixedColumn()){a.html("");var b=parseInt(r.table.select("td").style("border-width")),w=r.table.selectAll("tbody > tr > td:first-child");d=r.fixedColumn()?w.node().offsetWidth:0;var E=parseInt(d)+parseInt(2*b),S=a.selectAll("thead").data([0]);if(r.showHeader()){var x=S.enter().insert("thead","tbody").append("tr").style("background-color",r.theadRowBackgroundColor());S.exit().remove();var T=x.selectAll("th").data(h.filter(function(e,t){return t===0}));T.attr("class","update"),T.enter().append("th").html(function(e,t){return e[t].innerHTML}),T.style({width:E+"px",color:r.theadFontColor(),"font-size":r.theadFontSize(),"font-family":r.theadFontFamily(),"border-color":r.theadCellBorderColor()}),T.exit().remove()}var N=a.selectAll("tbody").data([0]);N.enter().append("tbody"),N.exit().remove();var C=N.selectAll("tr").data(w[0]);C.enter().append("tr").html(function(e){return e.outerHTML||"<td>&nbsp;</td>"}),r.totalledColumns()&&r.totalledLabel()&&N.append("tr").append("td").text(r.totalledLabel()),C.style({color:r.tbodyFontColor(),"font-size":r.tbodyFontSize(),"font-family":r.tbodyFontFamily(),"border-color":r.tbodyCellBorderColor()}),u.style("position","absolute"),a.style("width",d),r.fixedHeader()?(S.style({position:"absolute",width:E+"px"}),a.style("margin-top",-t.scrollTop+l+"px"),n.style("top",l+"px")):r.showHeader()?(S.style("margin-top","0px").style("position","relative"),a.style("margin-top",-t.scrollTop+"px"),n.style("top","0px")):S.remove();var k=a.selectAll("tr");k.on("click",function(t,n){e.select(i[0][n]).on("click.selectionBag")(i.data()[n-1],n-1)}).on("mouseover",function(t,n){e.select(i[0][n]).on("mouseover")(i.data()[n-1],n-1)}).on("mouseout",function(t,n){e.select(i[0][n]).on("mouseout")(i.data()[n-1],n-1)}).attr("class",function(t,n){var s=r.showHeader()?1:0;if(i[0][n-s]&&e.select(i[0][n-s]).classed("selected")===!0)return i[0][n-s].parentElement.querySelector(":hover")===i[0][n-s]?"selected hover":"selected"})}else d=0;r.showHeader()||(c=0);var L=e.select(".tableDiv > table").node().getBoundingClientRect();r.fixedSize()&&L.width!==0&&L.height!==0?(A(),O()):(r.node().offsetheight-parseInt(c)<=r.tableDiv.node().offsetHeight?O():r.fixedHeader()?(v=r.node().offsetHeight-parseInt(c),v+="px"):v="100%",r.node().offsetwidth-parseInt(d)<r.tableDiv.node().offsetWidth?A():r.fixedColumn()?(g=r.node().offsetWidth-parseInt(d),g+="px"):g="100%"),r.tableDiv.style("width",g).style("height",v).style("position","absolute").style("top",c+"px").style("left",d+"px").style("overflow","auto"),r.table.style({"margin-left":"-"+d+"px","margin-top":"-"+l+"px"}),u.style("width",d+"px"),a.style("margin-top",-r.tableDiv.node().scrollTop+c+"px"),a.select("thead").style("margin-top",r.tableDiv.node().scrollTop-c+"px").on("click",function(e,t){r.headerClick(e,t)})}function d(e){e.onscroll=function(e){var t=e.target.scrollLeft,n=e.target.scrollTop;o.style("margin-left",-t+"px"),a.style("margin-top",-n+c+"px"),a.select("thead").style("margin-top",n-c+"px")}}var r=this,i=this.tbody.selectAll("tr");i.selectAll("td").style({color:this.tbodyFontColor(),"font-size":this.tbodyFontSize(),"font-family":this.tbodyFontFamily(),"border-color":this.tbodyCellBorderColor()});var s=this.headerDiv.selectAll(".cols-wrapper").data(this.fixedHeader()?[0]:[]);s.enter().insert("div",".rows-wrapper").classed("cols-wrapper",!0).each(function(){e.select(this).append("table").classed("labels-wrapper",!0).append("thead")}),s.exit().remove();var o=s.select(".labels-wrapper"),u=this.headerDiv.selectAll(".rows-wrapper").data(this.fixedColumn()?[0]:[]);u.enter().append("div").attr("class","rows-wrapper").each(function(t){var n=e.select(this);n.append("table").classed("labels-wrapper",!0)}),u.exit().remove();var a=u.select(".labels-wrapper"),f=this.table.select("thead"),l=this.fixedHeader()||!this.showHeader()?f.node().offsetHeight:0,c=l;p(),d(this.tableDiv.node()),s.selectAll(".labels-wrapper tr").style("background-color",this.theadRowBackgroundColor()),u.selectAll(".labels-wrapper thead > tr").style("background-color",this.theadRowBackgroundColor());var h=u.selectAll(".labels-wrapper tbody > tr");r.applyRowStyles(h,!0),setTimeout(function(){r.applyStyleToRows(r.tbody.selectAll("tr"))},0)},i.prototype.exit=function(e,n){this._paginator.target(null),t.prototype.exit.apply(this,arguments)},i.prototype.sort=function(e){this._currentSort!==e?(this._currentSort=e,this._currentSortOrder=1):this._currentSortOrder*=-1;var t=this;return this.data().sort(function(n,r){return n[e]===r[e]?0:typeof r[e]=="undefined"||n[e]>r[e]?t._currentSortOrder:t._currentSortOrder*-1}),this},i.prototype.applyStyleToRows=function(t,n){var r=this;t.each(function(){var t=e.select(this);t.classed("hover")?r.applyHoverRowStyles(t):t.classed("selected")?r.applySelectedRowStyles(t):r.applyRowStyles(t,n)})},i.prototype.applyRowStyles=function(e,t){e.style({color:t?this.tbodyFixedColFontColor():this.tbodyFontColor(),"background-color":t?this.tbodyFixedColBackgroundColor():this.tableZebraColor_exists()&&this.data().indexOf(e.datum())%2?this.tbodyRowBackgroundColor():this.tableZebraColor()})},i.prototype.applyHoverRowStyles=function(e){e.style({color:this.tbodyHoverRowFontColor(),"background-color":this.tbodyHoverRowBackgroundColor()})},i.prototype.applySelectedRowStyles=function(e){e.style({color:this.tbodySelectedRowFontColor(),"background-color":this.tbodySelectedRowBackgroundColor()})},i.prototype.setRowEvents=function(t){var n=this;t.enter().append("tr").on("click.selectionBag",function(e,t){n.selectionBagClick(e),n.render();var r=n.headerDiv.selectAll(".rows-wrapper tbody tr").filter(function(e,n){return n===t}),i=n.table.selectAll("tbody tr").filter(function(e,n){return n===t});i.classed("hover",!0),n.applyRowStyles(i),n.applyRowStyles(r,!0)}).on("click",function(t){n.click(n.rowToObj(t),null,n._selectionBag.isSelected(n._createSelectionObject(t))),n.applyRowStyles(e.select(this))}).on("mouseover",function(e,t){var r=n.headerDiv.selectAll(".rows-wrapper tbody tr").filter(function(e,n){return n===t});if(r.empty())return;r.classed("hover",!0);var i=n.table.selectAll("tbody tr").filter(function(e,n){return n===t});i.classed("hover",!0),i.classed("selected")&&r.classed("selected",!0),n.applyStyleToRows(i),n.applyStyleToRows(r,!0)}).on("mouseout",function(e,t){var r=n.headerDiv.selectAll(".rows-wrapper tbody tr").filter(function(e,n){return n===t});r.classed("hover",!1);var i=n.table.selectAll("tbody tr").filter(function(e,n){return n===t}).classed("hover",!1);n.applyStyleToRows(i),n.applyStyleToRows(r,!0)})},i.prototype.selection=function(e){return arguments.length?(this._selectionBag.set(e.map(function(e){return this._createSelectionObject(e)},this)),this):this._selectionBag.get().map(function(e){return e._id})},i.prototype.selectionBagClick=function(t){if(e.event.shiftKey){var n=!1,r=[],i=this.data().filter(function(e,i){var s=!1;if(e===t||e===this._selectionPrevClick)n&&(s=!0),n=!n,r.push(i);return n||s},this);return this.selection(i),r}this._selectionBag.click(this._createSelectionObject(t),e.event),this._selectionPrevClick=t},i.prototype.getColumnFormatting=function(t,n){var r=this;if(typeof t=="string"){var i=e.time.format(r.columnPatterns()[n]);return i(new Date(t))}if(typeof t=="number"){var s=e.format(r.columnPatterns()[n]);return s(t)}return t},i.prototype.getColumnAlignment=function(e){var t=this;switch(typeof e){case"number":return function(){return t.numberAlign()};case"string":return function(){return t.stringAlign()};default:return""}},i.prototype.click=function(e,t){console.log("Click:  "+JSON.stringify(e)+", "+t)},i.prototype.headerClick=function(e,t){this.sort(t).render()},i});