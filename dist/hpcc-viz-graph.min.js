typeof define=="function"&&define.amd&&define("css",[],function(){return{load:function(e,t,n){n()}}}),function(e,t){typeof define=="function"&&define.amd?define("graph/Edge",["d3","../common/SVGWidget","../common/TextBox","css!./Edge"],t):e.graph_Edge=t(e.d3,e.common_SVGWidget,e.common_TextBox)}(this,function(e,t,n){function r(){t.call(this),this._points=[],this._weight=100,this._strokeDasharray=null,this._hidden=!1,this._textBox=(new n).padding(0)}return r.prototype=Object.create(t.prototype),r.prototype.constructor=r,r.prototype._class+=" graph_Edge",r.prototype.publish("arcDepth",16,"number","Arc Depth",null,{tags:["Basic"]}),r.prototype.publish("tooltip","","string","Tooltip",null,{tags:["Private"]}),r.prototype.sourceVertex=function(e){return arguments.length?(this._sourceVertex=e,this):this._sourceVertex},r.prototype.targetVertex=function(e){return arguments.length?(this._targetVertex=e,this):this._targetVertex},r.prototype.sourceMarker=function(e){return arguments.length?(this._sourceMarker=e,this):this._sourceMarker},r.prototype.targetMarker=function(e){return arguments.length?(this._targetMarker=e,this):this._targetMarker},r.prototype.weight=function(e){return arguments.length?(this._weight=e,this):this._weight},r.prototype.strokeDasharray=function(e){return arguments.length?(this._strokeDasharray=e,this):this._strokeDasharray},r.prototype.points=function(e,t,n){return arguments.length?(this._points=e,this._elementPath&&this.update(null,this._element,t,n),this):this._points},r.prototype.hidden=function(e){return arguments.length?(this._hidden=e,this):this._hidden},r.prototype.text=function(e){return arguments.length?(this._textBox.text(e),this):this._textBox.text()},r.prototype.enter=function(e,n){t.prototype.enter.apply(this,arguments),this._elementPath=n.append("path"),this._tooltipElement=this._elementPath.append("title"),this._sourceMarker&&this._elementPath.attr("marker-start","url(#"+this._sourceMarker+")"),this._targetMarker&&this._elementPath.attr("marker-end","url(#"+this._targetMarker+")"),this._textBox.text()&&this._textBox.target(e).tooltip(this.tooltip()).render()},r.prototype.update=function(n,r,i,s){t.prototype.update.apply(this,arguments);var o=this;this.svgMarkerGlitch&&!s&&r.transition().duration((i?i:0)+100).each("start",function(e){o._pushMarkers(r,e)}).each("end",function(e){o._popMarkers(r,e)});var u=o._calculateEdgePoints(this._sourceVertex,this._targetVertex,this._points),a="";if(this._points.length||i||!0)a=e.svg.line().x(function(e){return e.x}).y(function(e){return e.y}).interpolate("bundle").tension(.75)(u);else{var f=u[2].x-u[0].x,l=u[2].y-u[0].y,c=Math.sqrt(f*f+l*l)*2;a="M"+u[0].x+","+u[0].y+"A"+c+","+c+" 0 0,1 "+u[2].x+","+u[2].y}var h=this._elementPath;i&&(h=h.transition().duration(i)),h.attr("opacity",this._hidden?0:1).attr("stroke-dasharray",this._strokeDasharray).attr("d",a),this._tooltipElement.text(this.tooltip()),this._textBox.text()&&this._textBox.tooltip(this.tooltip()).move(this._findMidPoint(u),i)},r.prototype._findMidPoint=function(e){var t=e.length/2;if(e.length%2)return e[Math.floor(t)];if(e.length){var n=e[t-1],r=e[t];return{x:(n.x+r.x)/2,y:(n.y+r.y)/2}}return{x:0,y:0}},r.prototype._calculateEdgePoints=function(e,t,n){if(!e||!t)return[{x:0,y:0},{x:0,y:0}];var r=n?n.slice():[],i=r.length===0?t.pos():r[0],s=r.length===0?e.pos():r[r.length-1];r.unshift(e.intersection(e._pos,i)),r.push(t.intersection(t._pos,s)),r[0]||(r[0]=e._pos),r[r.length-1]||(r[r.length-1]=t._pos);if(r.length===2&&r[0]&&r[1]){var o=r[0].x-r[1].x,u=r[0].y-r[1].y,a=Math.sqrt(o*o+u*u);if(a){var f=(r[0].x+r[1].x)/2-u*this.arcDepth()/100,l=(r[0].y+r[1].y)/2+o*this.arcDepth()/100;r=[{x:r[0].x,y:r[0].y},{x:f,y:l},{x:r[1].x,y:r[1].y}]}}return r},r}),function(e,t){typeof define=="function"&&define.amd?define("graph/Vertex.js",["d3","../common/SVGWidget","../common/Icon","../common/TextBox","css!./Vertex"],t):e.graph_Vertex=t(e.d3,e.common_SVGWidget,e.common_Icon,e.common_TextBox)}(this,function(e,t,n,r){function i(){t.call(this),this._icon=new n,this._textBox=new r,this._annotationWidgets={}}return i.prototype=Object.create(t.prototype),i.prototype.constructor=i,i.prototype._class+=" graph_Vertex",i.prototype.publishProxy("faChar","_icon"),i.prototype.publishProxy("icon_shape_diameter","_icon","diameter"),i.prototype.publishProxy("icon_shape_colorFill","_icon","shape_colorFill"),i.prototype.publishProxy("icon_shape_colorStroke","_icon","shape_colorStroke"),i.prototype.publishProxy("icon_image_colorFill","_icon","image_colorFill"),i.prototype.publishProxy("text","_textBox"),i.prototype.publishProxy("anchor","_textBox"),i.prototype.publishProxy("textbox_shape_colorStroke","_textBox","shape_colorStroke"),i.prototype.publishProxy("textbox_shape_colorFill","_textBox","shape_colorFill"),i.prototype.publishProxy("textbox_text_colorFill","_textBox","text_colorFill"),i.prototype.publish("iconAnchor","start","set","Icon Anchor Position",["","start","middle","end"],{tags:["Basic"]}),i.prototype.publish("tooltip","","string","Tooltip",null,{tags:["Private"]}),i.prototype.publish("annotationDiameter",14,"number","Annotation Diameter",null,{tags:["Private"]}),i.prototype.publish("annotationSpacing",3,"number","Annotation Spacing",null,{tags:["Private"]}),i.prototype.publish("annotationIcons",[],"array","Annotations",null,{tags:["Private"]}),i.prototype.enter=function(e,n){t.prototype.enter.apply(this,arguments),this._icon.target(e).render(),this._textBox.target(e).render()},i.prototype.update=function(r,i){t.prototype.update.apply(this,arguments),this._icon.tooltip(this.tooltip()).render();var s=this._icon.getBBox(!0);this._textBox.tooltip(this.tooltip()).render();var o=this._textBox.getBBox(!0);switch(this.iconAnchor()){case"start":this._icon.move({x:-(o.width/2)+s.width/3,y:-(o.height/2)-s.height/3});break;case"middle":this._icon.move({x:0,y:-(o.height/2)-s.height/3});break;case"end":this._icon.move({x:o.width/2-s.width/3,y:-(o.height/2)-s.height/3})}var u=this,a=i.selectAll(".annotation").data(this.annotationIcons());a.enter().append("g").attr("class","annotation").each(function(e,t){u._annotationWidgets[t]=(new n).target(this).shape("square")});var f=o.width/2,l=o.height/2;a.each(function(e,t){var n=u._annotationWidgets[t];n.diameter(u.annotationDiameter()).shape_colorFill(u.textbox_shape_colorFill()).shape_colorStroke(u.textbox_shape_colorStroke());for(var r in e)n[r]&&n[r](e[r]);n.render();var i=n.getBBox(!0);n.move({x:f-i.width/4,y:l+i.height/4}),f-=i.width+u.annotationSpacing()}),a.exit().each(function(t,n){var r=e.select(this);delete u._annotationWidgets[n],r.remove()})},i.prototype.intersection=function(e,t){var n=this._icon.intersection(e,t,this._pos);if(n)return n;var r=this._textBox.intersection(e,t,this._pos);return r?r:null},i}),function(e,t){typeof define=="function"&&define.amd?define("graph/GraphData.js",["dagre"],t):e.graph_GraphData=t(e.dagre)}(this,function(e){function t(){e.graphlib.Graph.call(this,{multigraph:!0,compound:!0}),this.setGraph({}),this.setDefaultNodeLabel(function(){return{}}),this.setDefaultEdgeLabel(function(){return{}})}return t.prototype=Object.create(e.graphlib.Graph.prototype),t.prototype.constructor=t,t.prototype.setData=function(e,t,n,r){var i=this,s={addedVertices:[],addedEdges:[]};for(var o=0;o<e.length;++o){var u=e[o];if(!r||!this.hasNode(u._id))this.setNode(u._id,u),s.addedVertices.push(u)}for(o=0;o<t.length;++o){var a=t[o];if(!r||!this.hasEdge(a._id))this.setEdge(a._sourceVertex._id,a._targetVertex._id,a,a._id),s.addedEdges.push(a)}if(n)for(o=0;o<n.length;++o)this.setParent(n[o].child._id,n[o].parent._id);if(r){var f=t.map(function(e){return e._id});this.filterEdges(function(e){return f.indexOf(e.v+"_"+e.w)<0}).forEach(function(e){});var l=e.map(function(e){return e._id});this.filterNodes(function(e){return l.indexOf(e)<0}).forEach(function(e){try{i.delNode(e)}catch(t){}})}return s},t.prototype.filterEdges=function(e){var t=[];return this.eachEdge(function(n){e(n)&&t.push(n)}),t},t.prototype.filterNodes=function(e){var t=[];return this.eachNode(function(n){e(n)&&t.push(n)}),t},t.prototype.nodeValues=function(){var e=[];return this.nodes().forEach(function(t,n){e.push(this.node(t))},this),e},t.prototype.eachNode=function(e){this.nodes().forEach(function(t,n){e(t,this.node(t))},this)},t.prototype.edgeValues=function(){var e=[];return this.edges().forEach(function(t,n){e.push(this.edge(t))},this),e},t.prototype.eachEdge=function(e){this.edges().forEach(function(t,n){e(t,t.v,t.w,this.edge(t))},this)},t.prototype.getJSON=function(){var t=e.graphlib.json.write(this);return JSON.stringify(t,function(e,t){return e==="value"?t._text&&t._text._text?t._text._text:t._id:t},"  ")},t}),function(e,t){typeof define=="function"&&define.amd?define("graph/GraphLayouts.js",["d3","dagre"],t):e.graph_GraphLayouts=t(e.d3,e.dagre)}(this,function(e,t){function n(e,t,n,r){var i=this;this.pos={};var s=0;r=r||(t<n?t-s:n-s)/2;var o=e.nodeCount(),u=-Math.PI/2,a=2*Math.PI/o;e.eachNode(function(e,t){var n=t.getBBox(!0),s=Math.max(n.width,n.height);i.pos[e]={x:t.fixed?t.x:Math.cos(u)*(r-s),y:t.fixed?t.y:Math.sin(u)*(r-s),width:n.width,height:n.height},u+=a})}function r(e,t,n,r){var i=this;this.pos={},e.eachNode(function(e,t){i.pos[e]={x:t.x,y:t.y,width:t.width,height:t.height}})}function i(t,n,r,i){i=i||{};var s=this;this.pos={},this.vertices=[],this.vertexMap={},t.eachNode(function(e){var n=t.node(e),r=n.getBBox(!0),i={id:e,x:n.pos().x,y:n.pos().y,width:r.width,height:r.height,value:n};s.vertices.push(i),s.vertexMap[e]=i}),this.edges=[],t.eachEdge(function(e,t,n){s.edges.push({source:s.vertexMap[t],target:s.vertexMap[n]})}),this.force=e.layout.force().linkDistance(i.linkDistance).linkStrength(i.linkStrength).friction(i.friction).charge(function(e){var t=e.value.getBBox();return i.charge*Math.max(t.width,t.height)}).chargeDistance(i.chargeDistance).theta(i.theta).gravity(i.gravity).nodes(this.vertices).links(this.edges);if(i.oneShot){this.force.start();var o=t.nodeCount();o=Math.min(o*o,500);for(var u=0;u<o;++u)this.force.tick();this.force.stop()}}function s(e,n,r,i){var s=(new t.graphlib.Graph({multigraph:!0,compound:!0})).setGraph(i).setDefaultNodeLabel(function(){return{}}).setDefaultEdgeLabel(function(){return{}});e.eachNode(function(t){var n=e.node(t),r=n.getBBox();s.setNode(t,{width:r.width,height:r.height})}),e.eachEdge(function(t,n,r){var i=e.edge(t);s.setEdge(n,r,{weight:i.weight()},i._id)}),e.eachNode(function(t){s.setParent(t,e.parent(t))}),this.dagreLayout=t.layout(s);var o=-s.graph().width/2,u=-s.graph().height/2;s.nodes().forEach(function(e){var t=s.node(e);t.x+=o,t.y+=u}),s.edges().forEach(function(e){var t=s.edge(e);for(var n=0;n<t.points.length;++n)t.points[n].x+=o,t.points[n].y+=u}),this.digraph=s}n.prototype.nodePos=function(e){return this.pos[e]},n.prototype.edgePoints=function(e){return[]},r.prototype.nodePos=function(e){return this.pos[e]},r.prototype.edgePoints=function(e){return[]},i.prototype.nodePos=function(e){return this.vertexMap[e]},i.prototype.edgePoints=function(e){return[]},s.prototype.nodePos=function(e){return this.digraph.node(e)},s.prototype.edgePoints=function(e){return this.digraph.edge(e._sourceVertex.id(),e._targetVertex.id(),e._id).points};var o={None:r,Circle:n,ForceDirected:i,Hierarchy:s};return o}),function(e,t){typeof define=="function"&&define.amd?define("graph/Graph.js",["d3","../common/SVGWidget","../common/Palette","../api/IGraph","./Vertex","./Edge","./GraphData","./GraphLayouts","../common/Utility","css!./Graph"],t):e.graph_Graph=t(e.d3,e.common_SVGWidget,e.common_Palette,e.api_IGraph,e.graph_Vertex,e.graph_Edge,e.graph_GraphData,e.graph_GraphLayouts,e.common_Utility)}(this,function(e,t,n,r,i,s,o,u,a){function f(){t.call(this),r.call(this),this.graphData=new o,this.highlight={zoom:1.1,opacity:.33,edge:"1.25px"},this._selection=new a.Selection}return f.prototype=Object.create(t.prototype),f.prototype.constructor=f,f.prototype._class+=" graph_Graph",f.prototype.implements(r.prototype),f.prototype.Vertex=i,f.prototype.Edge=s,f.prototype.publish("allowDragging",!0,"boolean","Allow Dragging of Vertices",null,{tags:["Advanced"]}),f.prototype.publish("layout","Circle","set","Default Layout",["Circle","ForceDirected","ForceDirected2","Hierarchy","None"],{tags:["Basic"]}),f.prototype.publish("scale","100%","set","Zoom Level",["all","width","selection","100%","90%","75%","50%","25%","10%"],{tags:["Basic"]}),f.prototype.publish("applyScaleOnLayout",!1,"boolean","Shrink to fit on Layout",null,{tags:["Basic"]}),f.prototype.publish("highlightOnMouseOverVertex",!1,"boolean","Highlight Vertex on Mouse Over",null,{tags:["Basic"]}),f.prototype.publish("highlightOnMouseOverEdge",!1,"boolean","Highlight Edge on Mouse Over",null,{tags:["Basic"]}),f.prototype.publish("transitionDuration",250,"number","Transition Duration",null,{tags:["Intermediate"]}),f.prototype.publish("showEdges",!0,"boolean","Show Edges",null,{tags:["Intermediate"]}),f.prototype.publish("snapToGrid",0,"number","Snap to Grid",null,{tags:["Private"]}),f.prototype.publish("hierarchyRankDirection","TB","set","Direction for Rank Nodes",["TB","BT","LR","RL"],{tags:["Advanced"]}),f.prototype.publish("hierarchyNodeSeparation",50,"number","Number of pixels that separate nodes horizontally in the layout",null,{tags:["Advanced"]}),f.prototype.publish("hierarchyEdgeSeparation",10,"number","Number of pixels that separate edges horizontally in the layout",null,{tags:["Advanced"]}),f.prototype.publish("hierarchyRankSeparation",50,"number","Number of pixels between each rank in the layout",null,{tags:["Advanced"]}),f.prototype.publish("forceDirectedLinkDistance",300,"number","Target distance between linked nodes",null,{tags:["Advanced"]}),f.prototype.publish("forceDirectedLinkStrength",1,"number","Strength (rigidity) of links",null,{tags:["Advanced"]}),f.prototype.publish("forceDirectedFriction",.9,"number","Friction coefficient",null,{tags:["Advanced"]}),f.prototype.publish("forceDirectedCharge",-25,"number","Charge strength ",null,{tags:["Advanced"]}),f.prototype.publish("forceDirectedChargeDistance",1e4,"number","Maximum distance over which charge forces are applied",null,{tags:["Advanced"]}),f.prototype.publish("forceDirectedTheta",.8,"number","Barnes–Hut approximation criterion",null,{tags:["Advanced"]}),f.prototype.publish("forceDirectedGravity",.1,"number","Gravitational strength",null,{tags:["Advanced"]}),f.prototype.getOffsetPos=function(){return{x:0,y:0}},f.prototype.size=function(e){var n=t.prototype.size.apply(this,arguments);return arguments.length&&this._svgZoom&&this._svgZoom.attr("x",-this._size.width/2).attr("y",-this._size.height/2).attr("width",this._size.width).attr("height",this._size.height),n},f.prototype.clear=function(){this.data({vertices:[],edges:[],hierarchy:[],merge:!1})},f.prototype.data=function(e){var n=t.prototype.data.apply(this,arguments);if(arguments.length){this.data().merge||(this.graphData=new o,this._renderCount=0);var r=this.graphData.setData(this.data().vertices||[],this.data().edges||[],this.data().hierarchy||[],this.data().merge||!1),i=this;r.addedVertices.forEach(function(e){e.pos({x:+Math.random()*10/2-5,y:+Math.random()*10/2-5})}),r.addedEdges.forEach(function(e){e._sourceMarker&&(e._sourceMarker=i._id+"_"+e._sourceMarker),e._targetMarker&&(e._targetMarker=i._id+"_"+e._targetMarker)});var s={};this.graphData.edgeValues().forEach(function(e){s[e._sourceVertex._id]||(s[e._sourceVertex._id]={}),s[e._sourceVertex._id][e._targetVertex._id]||(s[e._sourceVertex._id][e._targetVertex._id]=0);var t=++s[e._sourceVertex._id][e._targetVertex._id];e.arcDepth(16*t)})}return n},f.prototype.selection=function(e){return arguments.length?(this._selection.set(e),this):this._selection.get()},f.prototype.setZoom=function(e,t,n){this.zoom&&(this.zoom.translate(e),this.zoom.scale(t),this.applyZoom(n))},f.prototype.applyZoom=function(t){e.event&&e.event.sourceEvent&&e.event.sourceEvent.ctrlKey&&(e.event.sourceEvent.type==="wheel"||e.event.sourceEvent.type==="mousewheel"||e.event.sourceEvent.type==="DOMMouseScroll")&&e.event.sourceEvent.wheelDelta&&(this.zoom.translate([this.prevTranslate[0],this.prevTranslate[1]+e.event.sourceEvent.wheelDelta]),this.zoom.scale(this.prevScale)),(t?this.svg.transition().duration(t):this.svg).attr("transform","translate("+this.zoom.translate()+")scale("+this.zoom.scale()+")"),this.prevTranslate=this.zoom.translate(),this.prevScale!==this.zoom.scale()&&(this._fixIEMarkers(),this.prevScale=this.zoom.scale()),this.brush.x(e.scale.identity().domain([(-this.prevTranslate[0]-this._size.width/2)*1/this.zoom.scale(),(-this.prevTranslate[0]+this._size.width/2)*1/this.zoom.scale()])),this.brush.y(e.scale.identity().domain([(-this.prevTranslate[1]-this._size.height/2)*1/this.zoom.scale(),(-this.prevTranslate[1]+this._size.height/2)*1/this.zoom.scale()]))},f.prototype.enter=function(n,r){function s(t){if(i.allowDragging()){e.event.sourceEvent.stopPropagation(),i._dragging=!0;if(i.forceLayout){var n=i.forceLayout.vertexMap[t.id()];n.fixed=!0}i.svgMarkerGlitch&&i.graphData.nodeEdges(t.id()).forEach(function(e){var t=i.graphData.edge(e);i._pushMarkers(t.element(),t)})}}function o(t){if(i.allowDragging()){e.event.sourceEvent.stopPropagation(),t.move({x:e.event.x,y:e.event.y});if(i.forceLayout){var n=i.forceLayout.vertexMap[t.id()];n.fixed=!0,n.x=n.px=e.event.x,n.y=n.py=e.event.y}i.refreshIncidentEdges(t,!0)}}function u(t){if(i.allowDragging()){e.event.sourceEvent.stopPropagation(),i._dragging=!1;if(i.snapToGrid()){var n=t.calcSnap(i.snapToGrid());t.move(n[0]),i.refreshIncidentEdges(t,!0)}if(i.forceLayout){var r=i.forceLayout.vertexMap[t.id()];r.fixed=!1}i.svgMarkerGlitch&&i.graphData.nodeEdges(t.id()).forEach(function(e){var t=i.graphData.edge(e);i._popMarkers(t.element(),t)})}}t.prototype.enter.apply(this,arguments);var i=this;this.prevTranslate=[0,0],this.prevScale=1,this.zoom=e.behavior.zoom().scaleExtent([.01,4]).on("zoomstart",function(t){i.prevTranslate=i.zoom.translate(),i.prevScale=i.zoom.scale(),e.event.sourceEvent&&e.event.sourceEvent.shiftKey&&e.event.sourceEvent.ctrlKey?i._zoomMode="selection":e.event.sourceEvent&&e.event.sourceEvent.shiftKey?(i._zoomMode="selection",i._selection.clear()):i._zoomMode="zoom";switch(i._zoomMode){case"selection":r.select(".extent").style("visibility",null);break;default:r.select(".extent").style("visibility","hidden")}}).on("zoomend",function(e){switch(i._zoomMode){case"selection":i.zoom.translate(i.prevTranslate),i.zoom.scale(i.prevScale);break;default:}i._svgBrush.call(i.brush.clear())}).on("zoom",function(e){switch(i._zoomMode){case"selection":break;default:i.applyZoom()}}),this.brush=e.svg.brush().x(e.scale.identity().domain([-i._size.width/2,i._size.width/2])).y(e.scale.identity().domain([-i._size.height/2,i._size.height/2])).on("brushstart",function(e){switch(i._zoomMode){case"selection":break;default:}}).on("brushend",function(t){switch(i._zoomMode){case"selection":var n=e.event.target.extent();i.svgV.selectAll(".graphVertex").select("*").each(function(e){n[0][0]<=e.x()&&e.x()<n[1][0]&&n[0][1]<=e.y()&&e.y()<n[1][1]&&i._selection.append(e)}),i.graph_selection(i.selection());break;default:}}).on("brush",function(){switch(i._zoomMode){case"selection":var t=i.zoom.translate();console.log(t[0]);var n=e.event.target.extent();i.svgV.selectAll(".graphVertex").select("*").classed("selected",function(e){return i._selection.isSelected(e)||n[0][0]<=e.x()&&e.x()<n[1][0]&&n[0][1]<=e.y()&&e.y()<n[1][1]});break;default:}}),this.drag=e.behavior.drag().origin(function(e){return e.pos()}).on("dragstart",s).on("dragend",u).on("drag",o),this._svgZoom=r.append("rect").attr("class","zoom").attr("x",-this._size.width/2).attr("y",-this._size.height/2).attr("width",this._size.width).attr("height",this._size.height),this.defs=r.append("defs"),this.addMarkers(),r.call(this.zoom),this.svg=r.append("g"),this._svgBrush=this.svg.append("g").attr("class","selectionBrush").call(this.brush),this._svgBrush.select(".background").style("cursor",null),i._svgBrush.call(i.brush.clear()),this.svgC=this.svg.append("g").attr("id",this._id+"C"),this.svgE=this.svg.append("g").attr("id",this._id+"E"),this.svgV=this.svg.append("g").attr("id",this._id+"V")},f.prototype.getBounds=function(e,t){var n=[[null,null],[null,null]];return e.forEach(function(e){var r=t?t.nodePos(e._id):{x:e.x(),y:e.y(),width:e.width(),height:e.height()},i=r.x-r.width/2,s=r.x+r.width/2,o=r.y-r.height/2,u=r.y+r.height/2;if(n[0][0]===null||n[0][0]>i)n[0][0]=i;if(n[0][1]===null||n[0][1]>o)n[0][1]=o;if(n[1][0]===null||n[1][0]<s)n[1][0]=s;if(n[1][1]===null||n[1][1]<u)n[1][1]=u}),n},f.prototype.getVertexBounds=function(e){return this.getBounds(this.graphData.nodeValues(),e)},f.prototype.getSelectionBounds=function(e){return this.getBounds(this._selection.get(),e)},f.prototype.shrinkToFit=function(e,t){var n=this.width(),r=this.height(),i=e[1][0]-e[0][0],s=e[1][1]-e[0][1],o=(e[0][0]+e[1][0])/2,u=(e[0][1]+e[1][1])/2,a=1/Math.max(i/n,s/r);a>1&&(a=1);var f=[-a*o,-a*u];this.setZoom(f,a,t)},f.prototype._origScale=f.prototype.scale,f.prototype.scale=function(e,t){var n=f.prototype._origScale.apply(this,arguments);return arguments.length&&this.zoomTo(e,t),n},f.prototype.zoomTo=function(e,t){switch(e){case"all":this.shrinkToFit(this.getVertexBounds(),t);break;case"width":var n=this.getVertexBounds();n[0][1]=0,n[1][1]=0,this.shrinkToFit(n,t);break;case"selection":this.shrinkToFit(this._selection.isEmpty()?this.getVertexBounds():this.getSelectionBounds(),t);break;default:var r=parseInt(e);if(isNaN(r)||r<=0||r>200)r=100;this.zoom.scale(r/100),this.applyZoom(t)}},f.prototype.centerOn=function(e,t){var n=(e[0][0]+e[1][0])/2,r=(e[0][1]+e[1][1])/2,i=[n,r];this.setZoom(i,1,t)},f.prototype._origLayout=f.prototype.layout,f.prototype.layout=function(e,t){var n=f.prototype._origLayout.apply(this,arguments);if(arguments.length&&this._renderCount){this.forceLayout&&(this.forceLayout.force.stop(),this.forceLayout=null);var r=this,i=this.getLayoutEngine();if(this.layout()==="ForceDirected2")this.forceLayout=i,this.forceLayout.force.on("tick",function(e){i.vertices.forEach(function(e){var t=r.graphData.node(e.id);e.fixed?(e.x=e.px,e.y=e.py):(e.px=e.x,e.py=e.y,t.move({x:e.x,y:e.y}))}),r.graphData.edgeValues().forEach(function(e){e.points([],!1,!1)});if(r.applyScaleOnLayout()){var t=r.getVertexBounds(i);r.shrinkToFit(t)}}),this.forceLayout.force.start();else if(i){this.forceLayout=null,r._dragging=!0,r.graphData.nodeValues().forEach(function(e){var n=i.nodePos(e._id);e.move({x:n.x,y:n.y},t),n.width&&n.height&&!e.width()&&!e.height()&&e.width(n.width).height(n.height).render()}),r.graphData.edgeValues().forEach(function(e){var n=i.edgePoints(e);e.points(n,t)});if(r.applyScaleOnLayout()){var s=r.getVertexBounds(i);r.shrinkToFit(s,t)}this._fixIEMarkers(),setTimeout(function(){r._dragging=!1},t?t+50:50)}}return n},f.prototype.update=function(n,r){function o(e){e.target(this).render(),e.element().call(i.drag),e.dispatch&&(e.dispatch.on("sizestart",function(e,t){e.allowResize(i.allowDragging()),i.allowDragging()&&(i._dragging=!0)}),e.dispatch.on("size",function(e,t){i.refreshIncidentEdges(e,!1)}),e.dispatch.on("sizeend",function(e,t){i._dragging=!1;if(i.snapToGrid()){var n=e.calcSnap(i.snapToGrid());e.pos(n[0]).size(n[1]).render(),i.refreshIncidentEdges(e,!1)}}))}function a(e){e.target(this).render()}function f(e){e.render()}function l(e){e.render()}t.prototype.update.apply(this,arguments);var i=this,s=this.svgV.selectAll("#"+this._id+"V > .graphVertex").data(this.graphData.nodeValues(),function(e){return e.id()});s.enter().append("g").attr("class","graphVertex").style("opacity",1e-6).on("click.selectionBag",function(t){i._selection.click(t,e.event)}).on("click",function(t){i.vertex_click(t,e.event)}).on("dblclick",function(t){i.vertex_dblclick(t,e.event)}).on("mouseover",function(t){if(i._dragging)return;i.vertex_mouseover(e.select(this),t)}).on("mouseout",function(t){if(i._dragging)return;i.vertex_mouseout(e.select(this),t)}).each(o).transition().duration(750).style("opacity",1);var u=this.svgE.selectAll("#"+this._id+"E > .graphEdge").data(this.showEdges()?this.graphData.edgeValues():[],function(e){return e.id()});u.enter().append("g").attr("class","graphEdge").style("opacity",1e-6).on("click.selectionBag",function(t){i._selection.click(t,e.event)}).on("click",function(e){i.edge_click(e)}).on("mouseover",function(t){if(i._dragging)return;i.edge_mouseover(e.select(this),t)}).on("mouseout",function(t){if(i._dragging)return;i.edge_mouseout(e.select(this),t)}).each(a).transition().duration(750).style("opacity",1),s.each(f),u.each(l),s.exit().each(function(e){e.target(null)}).remove(),u.exit().each(function(e){e.target(null)}).remove(),this._renderCount||(this._renderCount++,this.setZoom([0,0],1),this.layout(this.layout()))},f.prototype.getLayoutEngine=function(){switch(this.layout()){case"Circle":return new u.Circle(this.graphData,this._size.width,this._size.height);case"ForceDirected":return new u.ForceDirected(this.graphData,this._size.width,this._size.height,{oneShot:!0,linkDistance:this.forceDirectedLinkDistance(),linkStrength:this.forceDirectedLinkStrength(),friction:this.forceDirectedFriction(),charge:this.forceDirectedCharge(),chargeDistance:this.forceDirectedChargeDistance(),theta:this.forceDirectedTheta(),gravity:this.forceDirectedGravity()});case"ForceDirected2":return new u.ForceDirected(this.graphData,this._size.width,this._size.height,{linkDistance:this.forceDirectedLinkDistance(),linkStrength:this.forceDirectedLinkStrength(),friction:this.forceDirectedFriction(),charge:this.forceDirectedCharge(),chargeDistance:this.forceDirectedChargeDistance(),theta:this.forceDirectedTheta(),gravity:this.forceDirectedGravity()});case"Hierarchy":return new u.Hierarchy(this.graphData,this._size.width,this._size.height,{rankdir:this.hierarchyRankDirection(),nodesep:this.hierarchyNodeSeparation(),edgesep:this.hierarchyEdgeSeparation(),ranksep:this.hierarchyRankSeparation()})}return null},f.prototype.getNeighborMap=function(e){var t={},n={};if(e){var r=this.graphData.nodeEdges(e.id());for(var i=0;i<r.length;++i){var s=this.graphData.edge(r[i]);n[s.id()]=s,s._sourceVertex.id()!==e.id()&&(t[s._sourceVertex.id()]=s._sourceVertex),s._targetVertex.id()!==e.id()&&(t[s._targetVertex.id()]=s._targetVertex)}}return{vertices:t,edges:n}},f.prototype.highlightVerticies=function(e){var t=this,n=this.svgV.selectAll(".graphVertex");return n.transition().duration(this.transitionDuration()).each("end",function(t){e&&e[t.id()]&&t._parentElement.node()&&t._parentElement.node().parentNode&&t._parentElement.node().parentNode.appendChild(t._parentElement.node())}).style("opacity",function(n){return!e||e[n.id()]?1:t.highlight.opacity}),this},f.prototype.highlightEdges=function(e){var t=this,n=this.svgE.selectAll(".graphEdge");return n.style("stroke-width",function(n){return e&&e[n.id()]?t.highlight.edge:"1px"}).transition().duration(this.transitionDuration()).style("opacity",function(n){return!e||e[n.id()]?1:t.highlight.opacity}),this},f.prototype.highlightVertex=function(e,t){if(this.highlightOnMouseOverVertex())if(t){var n=this.getNeighborMap(t);n.vertices[t.id()]=t,this.highlightVerticies(n.vertices),this.highlightEdges(n.edges)}else this.highlightVerticies(null),this.highlightEdges(null)},f.prototype.highlightEdge=function(e,t){if(this.highlightOnMouseOverEdge())if(t){var n={};n[t._sourceVertex.id()]=t._sourceVertex,n[t._targetVertex.id()]=t._targetVertex;var r={};r[t.id()]=t,this.highlightVerticies(n),this.highlightEdges(r)}else this.highlightVerticies(null),this.highlightEdges(null)},f.prototype.refreshIncidentEdges=function(e,t){var n=this;this.graphData.nodeEdges(e.id()).forEach(function(e){var r=n.graphData.edge(e);r.points([],!1,t)})},f.prototype.graph_selection=function(e){},f.prototype.vertex_click=function(e){e._parentElement.node().parentNode.appendChild(e._parentElement.node()),r.prototype.vertex_click.apply(this,arguments)},f.prototype.vertex_dblclick=function(e){},f.prototype.vertex_mouseover=function(e,t){this.highlightVertex(e,t)},f.prototype.vertex_mouseout=function(e,t){this.highlightVertex(null,null)},f.prototype.edge_mouseover=function(e,t){this.highlightEdge(e,t)},f.prototype.edge_mouseout=function(e,t){this.highlightEdge(null,null)},f.prototype.addMarkers=function(e){e&&(this.defs.select("#"+this._id+"_arrowHead").remove(),this.defs.select("#"+this._id+"_circleFoot").remove(),this.defs.select("#"+this._id+"_circleHead").remove()),this.defs.append("marker").attr("class","marker").attr("id",this._id+"_arrowHead").attr("viewBox","0 0 10 10").attr("refX",10).attr("refY",5).attr("markerWidth",8).attr("markerHeight",8).attr("markerUnits","strokeWidth").attr("orient","auto").append("polyline").attr("points","0,0 10,5 0,10 1,5"),this.defs.append("marker").attr("class","marker").attr("id",this._id+"_circleFoot").attr("viewBox","0 0 10 10").attr("refX",1).attr("refY",5).attr("markerWidth",7).attr("markerHeight",7).attr("markerUnits","strokeWidth").attr("orient","auto").append("circle").attr("cx",5).attr("cy",5).attr("r",4),this.defs.append("marker").attr("class","marker").attr("id",this._id+"_circleHead").attr("viewBox","0 0 10 10").attr("refX",9).attr("refY",5).attr("markerWidth",7).attr("markerHeight",7).attr("markerUnits","strokeWidth").attr("orient","auto").append("circle").attr("cx",5).attr("cy",5).attr("r",4)},f}),function(e,t){typeof define=="function"&&define.amd?define("graph/Sankey.js",["d3","../common/SVGWidget","../common/Palette","../common/PropertyExt","../common/Utility","d3-sankey","css!./Sankey"],t):e.graph_Sankey=t(e.d3,e.common_SVGWidget,e.common_Palette,e.common_PropertyExt,e.common_Utility,e.d3.sankey)}(this,function(e,t,n,r,i,s){function o(e){r.call(this),this._owner=e}function u(e){t.call(this),this._drawStartPos="origin"}return s=s||e.sankey||window.d3.sankey,o.prototype=Object.create(r.prototype),o.prototype.constructor=o,o.prototype._class+=" graph_Sankey.Column",o.prototype.publish("column",null,"set","Field",function(){return this._owner?this._owner.columns():[]},{optional:!0}),o.prototype.publish("aggrType",null,"set","Aggregation Type",[null,"mean","median","sum","min","max"],{optional:!0,disable:function(e){return!e._owner||e._owner.mappings().indexOf(e)===0}}),o.prototype.publish("aggrColumn",null,"set","Aggregation Field",function(){return this._owner?this._owner.columns():[]},{optional:!0,disable:function(e){return!e._owner||!e.aggrType()||e._owner.mappings().indexOf(e)===0}}),o.prototype.aggregate=function(t){switch(this.aggrType()){case null:case undefined:case"":return t.length;default:var n=this._owner.columns(),r=n.indexOf(this.aggrColumn());return e[this.aggrType()](t,function(e){return+e[r]})}},u.prototype=Object.create(t.prototype),u.prototype.constructor=u,u.prototype._class+=" graph_Sankey",u.prototype.Column=o,u.prototype._palette=n.ordinal("default"),u.prototype.publish("paletteID","default","set","Palette ID",u.prototype._palette.switch()),u.prototype.publish("mappings",[],"propertyArray","Source Columns",null,{autoExpand:o}),u.prototype.publish("vertexWidth",36,"number","Vertex Width"),u.prototype.publish("vertexPadding",40,"number","Vertex Padding"),u.prototype.publish("xAxisMovement",!1,"boolean","Enable x-axis movement"),u.prototype.publish("yAxisMovement",!1,"boolean","Enable y-axis movement"),u.prototype.sankeyData=function(){var e={},t={vertices:[],edges:[]},n=this.mappings().filter(function(e){return e.column()});return n.forEach(function(n,r){var i=this._db.rollupView([n.column()]);i.entries().forEach(function(i){var s=n.column()+":"+r+":"+i.key;e[s]||(t.vertices.push({__id:s,__category:n.column(),name:i.key,origRow:i.values}),e[s]=t.vertices.length-1)},this)},this),n.forEach(function(r,i){if(i<n.length-1){var s=n[i+1],o=this._db.rollupView([r.column(),s.column()]);o.entries().forEach(function(n){var o=r.column()+":"+i+":"+n.key;n.values.forEach(function(n){var r=s.column()+":"+(i+1)+":"+n.key;t.edges.push({__id:o+"_"+r,source:e[o],target:e[r],value:s.aggregate(n.values)})})})}},this),t},u.prototype.enter=function(e,n){t.prototype.enter.apply(this,arguments),this._d3Sankey=new s,this._d3SankeyPath=this._d3Sankey.link(),this._selection=new i.SimpleSelection(n)},u.prototype.update=function(n,r){t.prototype.update.apply(this,arguments),this._palette=this._palette.switch(this.paletteID());var i=this.sankeyData();this._d3Sankey.size([this.width(),this.height()]).nodeWidth(this.vertexWidth()).nodePadding(this.vertexPadding()).nodes(i.vertices).links(i.edges).layout(32);var s=this,o=r.selectAll(".link").data(i.edges);o.enter().append("path").attr("class","link").append("title"),o.attr("d",this._d3SankeyPath).style("stroke-width",function(e){return Math.max(1,e.dy)}).sort(function(e,t){return t.dy-e.dy}),o.select("title").text(function(e){return e.source.name+" → "+e.target.name+"\n"+e.value}),o.exit().remove();var u=r.selectAll(".node").data(i.vertices);u.enter().append("g").attr("class","node").call(this._selection.enter.bind(this._selection)).on("click",function(e,t){s.click(s.rowToObj(e.origRow[0]),"",s._selection.selected(this))}).each(function(t){var n=e.select(this);n.append("rect"),n.append("text")}),u.attr("transform",function(e){return"translate("+e.x+","+e.y+")"}),u.select("rect").attr("height",function(e){return e.dy}).attr("width",this._d3Sankey.nodeWidth()).style("fill",function(e){return s._palette(e.name)}).style("cursor",this.xAxisMovement()||this.yAxisMovement()?null:"default"),u.select("text").attr("x",-6).attr("y",function(e){return e.dy/2}).attr("dy",".35em").attr("text-anchor","end").attr("transform",null).text(function(e){return e.name}).filter(function(e){return e.x<s.width()/2}).attr("x",6+this._d3Sankey.nodeWidth()).attr("text-anchor","start"),u.exit().remove()},u.prototype.exit=function(e,n){t.prototype.exit.apply(this,arguments)},u.prototype.click=function(e,t,n){console.log("Click:  "+JSON.stringify(e)+", "+t+","+n)},u});